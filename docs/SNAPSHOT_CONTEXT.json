{
  "generated_at": "2026-01-29T01:19:56.068663Z",
  "root": "C:\\workspace\\dale-vision",
  "tree": {
    "apps": [
      "apps/",
      "apps\\accounts/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    serializers.py",
      "    tests.py",
      "    urls.py",
      "    views.py",
      "apps\\accounts\\migrations/",
      "      __init__.py",
      "apps\\alerts/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    serializers.py",
      "    services.py",
      "    tests.py",
      "    urls.py",
      "    views.py",
      "apps\\alerts\\migrations/",
      "      __init__.py",
      "apps\\analytics/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    tests.py",
      "    views.py",
      "apps\\analytics\\migrations/",
      "      __init__.py",
      "apps\\billing/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    tests.py",
      "    views.py",
      "apps\\billing\\migrations/",
      "      __init__.py",
      "apps\\cameras/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    serializers.py",
      "    services.py",
      "    tests.py",
      "    urls.py",
      "    views.py",
      "apps\\cameras\\migrations/",
      "      0001_initial.py",
      "      0002_delete_camera.py",
      "      __init__.py",
      "apps\\core/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    tests.py",
      "    views.py",
      "apps\\core\\management/",
      "      __init__.py",
      "apps\\core\\management\\commands/",
      "        __init__.py",
      "        seed_demo.py",
      "apps\\core\\migrations/",
      "      0001_initial.py",
      "      0002_alertrule_auditlog_billingcustomer_camera_and_more.py",
      "      __init__.py",
      "apps\\edge/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    permissions.py",
      "    serializers.py",
      "    tests.py",
      "    urls.py",
      "    views.py",
      "apps\\edge\\migrations/",
      "      0001_initial.py",
      "      __init__.py",
      "apps\\stores/",
      "    __init__.py",
      "    admin.py",
      "    apps.py",
      "    models.py",
      "    serializers.py",
      "    tests.py",
      "    urls.py",
      "    views.py",
      "apps\\stores\\migrations/",
      "      0001_initial.py",
      "      0002_remove_store_is_active.py",
      "      __init__.py",
      "apps\\vision/",
      "    __init__.py",
      "    apps.py",
      "    tests.py",
      "    views.py",
      "apps\\vision\\migrations/",
      "      0001_initial.py",
      "      0002_alter_detectionevent_camera.py",
      "      0003_delete_detectionevent.py",
      "      __init__.py"
    ],
    "backend": [
      "backend/",
      "  .env",
      "  __init__.py",
      "  asgi.py",
      "  settings.py",
      "  urls.py",
      "  wsgi.py"
    ],
    "frontend/src": [
      "frontend\\src/",
      "    App.tsx",
      "    index.css",
      "    main.tsx",
      "frontend\\src\\assets/",
      "      logo.png",
      "      react.svg",
      "frontend\\src\\components/",
      "      PrivateRoute.tsx",
      "frontend\\src\\components\\Agent/",
      "        AgentModal.tsx",
      "frontend\\src\\components\\Charts/",
      "        LineChart.tsx",
      "        PieChart.tsx",
      "frontend\\src\\components\\Layout/",
      "        BottomNav.tsx",
      "        Header.tsx",
      "        Layout.tsx",
      "        Sidebar.tsx",
      "        index.ts",
      "frontend\\src\\components\\Skeletons/",
      "        DashboardSkeleton.tsx",
      "frontend\\src\\contexts/",
      "      AgentContext.tsx",
      "      AuthContext.tsx",
      "frontend\\src\\hooks/",
      "      useIsMobile.ts",
      "      useRevealOnScroll.ts",
      "frontend\\src\\pages/",
      "frontend\\src\\pages\\AgendarDemo/",
      "        AgendarDemo.tsx",
      "frontend\\src\\pages\\AlertRules/",
      "        AlertRules.tsx",
      "frontend\\src\\pages\\Alerts/",
      "        Alerts.tsx",
      "frontend\\src\\pages\\Analytics/",
      "        Analytics.tsx",
      "frontend\\src\\pages\\Cameras/",
      "        Cameras.tsx",
      "frontend\\src\\pages\\Dashboard/",
      "        Dashboard.tsx",
      "frontend\\src\\pages\\Home/",
      "        Home.tsx",
      "frontend\\src\\pages\\Login/",
      "        Login.tsx",
      "frontend\\src\\pages\\NotificationLogs/",
      "        NotificationLogs.tsx",
      "frontend\\src\\pages\\Onboarding/",
      "        Onboarding.tsx",
      "        OnboardingSuccess.tsx",
      "frontend\\src\\pages\\Onboarding\\components/",
      "          CamerasSetup.tsx",
      "          EmployeesSetup.tsx",
      "          OnboardingProgress.tsx",
      "          StoresSetup.tsx",
      "frontend\\src\\pages\\Profile/",
      "        Profile.tsx",
      "frontend\\src\\pages\\Register/",
      "        Register.tsx",
      "frontend\\src\\pages\\Settings/",
      "        Settings.tsx",
      "frontend\\src\\pages\\Stores/",
      "        Stores.tsx",
      "frontend\\src\\queries/",
      "      alerts.queries.ts",
      "frontend\\src\\services/",
      "      alerts.ts",
      "      api.ts",
      "      auth.ts",
      "      demo.ts",
      "      stores.ts",
      "frontend\\src\\types/",
      "      dashboard.ts"
    ],
    "frontend/public": [
      "frontend\\public/",
      "    vite.svg"
    ],
    "frontend/package.json": [
      "frontend/package.json"
    ],
    "frontend/vite.config.ts": [
      "frontend/vite.config.ts"
    ],
    "frontend/tsconfig.json": [
      "frontend/tsconfig.json"
    ],
    "frontend/tsconfig.app.json": [
      "frontend/tsconfig.app.json"
    ],
    "frontend/tsconfig.node.json": [
      "frontend/tsconfig.node.json"
    ],
    "edge-agent": [
      "edge-agent/",
      "edge-agent\\config/",
      "    agent.yaml",
      "edge-agent\\config\\rois/",
      "      cam01.yaml",
      "      cam02.yaml",
      "      cam03.yaml",
      "edge-agent\\data/",
      "    edge_queue.db",
      "edge-agent\\models/",
      "    yolov8n.pt",
      "edge-agent\\runs/",
      "edge-agent\\runs\\detect/",
      "edge-agent\\runs\\detect\\predict/",
      "edge-agent\\runs\\detect\\predict2/",
      "edge-agent\\runs\\detect\\predict3/",
      "edge-agent\\runs\\detect\\predict4/",
      "edge-agent\\src/",
      "    __init__.py",
      "edge-agent\\src\\agent/",
      "      __init__.py",
      "      lifecycle.py",
      "      main.py",
      "      settings.py",
      "edge-agent\\src\\camera/",
      "      rtsp.py",
      "edge-agent\\src\\events/",
      "      builder.py",
      "      receipts.py",
      "edge-agent\\src\\storage/",
      "      __init__.py",
      "      sqlite_queue.py",
      "edge-agent\\src\\transport/",
      "      api_client.py",
      "edge-agent\\src\\vision/",
      "      aggregations.py",
      "      detector.py",
      "      rules.py"
    ],
    "scripts": [
      "scripts/",
      "  generate_context_snapshot.py"
    ],
    "contracts": [
      "(missing) contracts"
    ],
    "docs": [
      "docs/",
      "  SNAPSHOT_CONTEXT.json",
      "  SNAPSHOT_CONTEXT.md"
    ]
  },
  "important_files_preview": {
    "backend/settings.py": "# backend/settings.py\nimport os\nfrom pathlib import Path\nfrom dotenv import load_dotenv\nfrom datetime import timedelta\n# Carrega vari√°veis do .env\nload_dotenv()\n\nBASE_DIR = Path(__file__).resolve().parent.parent\n\n# SECURITY WARNING: keep the secret key used in production secret!\nSECRET_KEY = os.getenv('DJANGO_SECRET_KEY', 'django-insecure-change-me-in-production!')\n\n# SECURITY WARNING: don't run with debug turned on in production!\nDEBUG = os.getenv('DEBUG', 'True') == 'True'\n\nALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')\n\n# ‚≠ê APPLICATION DEFINITION - APENAS ESSENCIAIS INICIALMENTE\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',      # ‚≠ê N√ÉO CRIAR 'apps.auth' - ESTE √â O OFICIAL\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    \n    # Third party\n    'rest_framework',\n    'corsheaders',\n    'knox',\n    'django_filters',\n    'drf_yasg',\n    \n    # ‚≠ê LOCAL APPS - VAMOS CRIAR AGORA\n    'apps.accounts',\n    'apps.core',\n    'apps.stores',\n    'apps.cameras', \n    'apps.vision',\n    'apps.analytics',\n    'apps.alerts',\n    'apps.billing',\n    \"apps.edge\",\n]\n\nMIDDLEWARE = [\n    'corsheaders.middleware.CorsMiddleware',\n    'django.middleware.security.SecurityMiddleware',\n    'whitenoise.middleware.WhiteNoiseMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nROOT_URLCONF = 'backend.urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'backend.wsgi.application'\n\n# ‚≠ê DATABASE - Supabase Postgres (prod e dev)\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql',\n        'NAME': os.getenv('DB_NAME', 'postgres'),\n        'USER': os.getenv('DB_USER', 'postgres'),\n        'PASSWORD': os.getenv('DB_PASSWORD', ''),\n        'HOST': os.getenv('DB_HOST', ''),\n        'PORT': os.getenv('DB_PORT', '5432'),\n        'OPTIONS': {\n            'sslmode': os.getenv('DB_SSLMODE', 'require'),\n        }\n    }\n}\n\n# Password validation\nAUTH_PASSWORD_VALIDATORS = [\n    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},\n]\n\n# Internationalization\nLANGUAGE_CODE = 'pt-br'\nTIME_ZONE = 'America/Sao_Paulo'\nUSE_I18N = True\nUSE_TZ = True\n\n# Static files (CSS, JavaScript, Images)\nSTATIC_URL = 'static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\n\n# Default primary key field type\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\n# ‚≠ê REST FRAMEWORK CONFIG\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': ('knox.auth.TokenAuthentication',),\n    'DEFAULT_PERMISSION_CLASSES': ('rest_framework.permissions.IsAuthenticatedOrReadOnly',),\n    'DEFAULT_FILTER_BACKENDS': ['django_filters.rest_framework.DjangoFilterBackend'],\n    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',\n    'PAGE_SIZE': 50,\n}\n\n# ‚≠ê CORS CONFIG\nCORS_ALLOWED_ORIGINS = [\n    \"http://localhost:5173\",\n    \"http://127.0.0.1:5173\",\n]\nCORS_ALLOW_CREDENTIALS = True\n\nCORS_ALLOW_METHODS = [\n    'DELETE',\n    'GET',\n    'OPTIONS',\n    'PATCH',\n    'POST',\n    'PUT',\n]\nCORS_ALLOW_HEADERS = [\n    'accept',\n    'accept-encoding',\n    'authorization',\n    'content-type',\n    'dnt',\n    'origin',\n    'user-agent',\n    'x-csrftoken',\n    'x-requested-with',\n]\n# ‚≠ê KNOX CONFIG\nREST_KNOX = {\n    'TOKEN_TTL': timedelta(days=30),\n    'AUTO_REFRESH': True,\n}\n\n# ‚≠ê SUPABASE CONFIG (SEUS DADOS)\nSUPABASE_URL = os.getenv(\"SUPABASE_URL\")\nSUPABASE_KEY = os.getenv(\"SUPABASE_KEY\")\nN8N_EVENTS_WEBHOOK = os.getenv(\"N8N_EVENTS_WEBHOOK\")\n# ‚≠ê WHITENOISE (para arquivos est√°ticos)\nSTATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'\n\nEDGE_SERVICE_USERNAME = os.getenv(\"EDGE_SERVICE_USERNAME\", \"edge-agent\")\nEDGE_AGENT_TOKEN = os.getenv(\"EDGE_AGENT_TOKEN\", \"\")",
    "backend/urls.py": "# backend/urls.py\nfrom django.contrib import admin\nfrom django.urls import path, include\nfrom django.http import JsonResponse\nfrom rest_framework import permissions\nfrom drf_yasg.views import get_schema_view\nfrom drf_yasg import openapi\n\ndef home(request):\n    return JsonResponse({\n        \"app\": \"Dale Vision IA\",\n        \"version\": \"1.0.0\",\n        \"status\": \"online\",\n        \"documentation\": \"/swagger/\",\n        \"endpoints\": {\n            \"register\": \"/api/accounts/register/\",\n            \"login\": \"/api/accounts/login/\",\n            \"logout\": \"/api/accounts/logout/\",\n            \"stores\": \"/api/v1/stores/\",\n            \"alerts\": \"/api/alerts/\",\n        }\n    })\n\nschema_view = get_schema_view(\n    openapi.Info(\n        title=\"Dale Vision API\",\n        default_version=\"v1\",\n        description=\"API de Vis√£o Computacional para Varejo\",\n        contact=openapi.Contact(email=\"dev@dalevision.ai\"),\n        license=openapi.License(name=\"Proprietary\"),\n    ),\n    public=True,\n    permission_classes=[permissions.AllowAny],\n)\n\nurlpatterns = [\n    path(\"\", home),\n    path(\"admin/\", admin.site.urls),\n\n    path(\"swagger/\", schema_view.with_ui(\"swagger\", cache_timeout=0), name=\"swagger-ui\"),\n    path(\"redoc/\", schema_view.with_ui(\"redoc\", cache_timeout=0), name=\"redoc\"),\n\n    # ‚úÖ Accounts centralizado\n    path(\"api/accounts/\", include(\"apps.accounts.urls\")),\n\n    # ‚úÖ Core (demo lead etc) ‚Äî se voc√™ for colocar aqui depois\n    # path(\"api/core/\", include(\"apps.core.urls\")),\n\n    # ‚úÖ Stores\n    path(\"api/v1/\", include(\"apps.stores.urls\")),\n\n    # ‚úÖ Alerts (demo lead + rules + ingest/event)\n    path(\"api/alerts/\", include(\"apps.alerts.urls\")),\n    path(\"api/cameras/\", include(\"apps.cameras.urls\")),\n\n    path(\"health/\", lambda r: JsonResponse({\"status\": \"healthy\", \"service\": \"dale-vision-api\"})),\n    path(\"api/edge/\", include(\"apps.edge.urls\")),\n]\n",
    "backend/asgi.py": "\"\"\"\nASGI config for backend project.\n\nIt exposes the ASGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/asgi/\n\"\"\"\n\nimport os\n\nfrom django.core.asgi import get_asgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\napplication = get_asgi_application()\n",
    "backend/wsgi.py": "\"\"\"\nWSGI config for backend project.\n\nIt exposes the WSGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/\n\"\"\"\n\nimport os\n\nfrom django.core.wsgi import get_wsgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\napplication = get_wsgi_application()\n",
    "apps/accounts/views.py": "# apps/accounts/views.py\nfrom rest_framework import status\nfrom rest_framework.response import Response\nfrom rest_framework.views import APIView\nfrom rest_framework.permissions import AllowAny\nfrom knox.models import AuthToken\nfrom django.contrib.auth import authenticate\n\nfrom drf_yasg.utils import swagger_auto_schema  # ‚úÖ\nfrom drf_yasg import openapi  # (opcional)\n\nfrom .serializers import RegisterSerializer, LoginSerializer\n\n\nclass RegisterView(APIView):\n    permission_classes = [AllowAny]\n\n    @swagger_auto_schema(request_body=RegisterSerializer, responses={201: openapi.Response(\"Created\")})\n    def post(self, request):\n        serializer = RegisterSerializer(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        user = serializer.save()\n        token = AuthToken.objects.create(user)[1]\n\n        return Response(\n            {\n                \"user\": {\n                    \"id\": user.id,\n                    \"username\": user.username,\n                    \"email\": user.email,\n                    \"first_name\": user.first_name,\n                    \"last_name\": user.last_name,\n                },\n                \"token\": token,\n            },\n            status=status.HTTP_201_CREATED,\n        )\n\n\nclass LoginView(APIView):\n    permission_classes = [AllowAny]\n\n    @swagger_auto_schema(request_body=LoginSerializer, responses={200: openapi.Response(\"OK\")})\n    def post(self, request):\n        serializer = LoginSerializer(data=request.data, context={\"request\": request})\n        serializer.is_valid(raise_exception=True)\n\n        user = serializer.validated_data[\"user\"]\n        token = AuthToken.objects.create(user)[1]\n\n        return Response(\n            {\n                \"user\": {\n                    \"id\": user.id,\n                    \"username\": user.username,\n                    \"email\": user.email,\n                    \"first_name\": user.first_name,\n                    \"last_name\": user.last_name,\n                },\n                \"token\": token,\n            },\n            status=status.HTTP_200_OK,\n        )\n",
    "apps/accounts/serializers.py": "# apps/accounts/serializers.py\nfrom rest_framework import serializers\nfrom django.contrib.auth.models import User\nfrom django.contrib.auth import authenticate\nclass UserSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = User\n        fields = [\"id\", \"username\", \"email\", \"first_name\", \"last_name\"]\n        read_only_fields = [\"id\"]\n\nclass RegisterSerializer(serializers.ModelSerializer):\n    password = serializers.CharField(write_only=True, min_length=6)\n\n    class Meta:\n        model = User\n        fields = [\"username\", \"email\", \"password\", \"first_name\", \"last_name\"]\n\n    def validate_email(self, value):\n        if User.objects.filter(email=value).exists():\n            raise serializers.ValidationError(\"Este email j√° est√° em uso.\")\n        return value\n\n    def create(self, validated_data):\n        return User.objects.create_user(\n            username=validated_data[\"username\"],\n            email=validated_data[\"email\"],\n            password=validated_data[\"password\"],\n            first_name=validated_data.get(\"first_name\", \"\"),\n            last_name=validated_data.get(\"last_name\", \"\"),\n        )\n\nclass LoginSerializer(serializers.Serializer):\n    username = serializers.CharField(required=True)\n    password = serializers.CharField(required=True, write_only=True)\n\n    def validate(self, attrs):\n        user = authenticate(\n            request=self.context.get(\"request\"),\n            username=attrs[\"username\"],\n            password=attrs[\"password\"],\n        )\n        if not user:\n            raise serializers.ValidationError(\"Credenciais inv√°lidas.\")\n        if not user.is_active:\n            raise serializers.ValidationError(\"Usu√°rio inativo.\")\n        attrs[\"user\"] = user\n        return attrs\n",
    "apps/accounts/urls.py": "# apps/accounts/urls.py\nfrom django.urls import path\nfrom knox import views as knox_views\nfrom .views import RegisterView, LoginView\n\nurlpatterns = [\n    path(\"register/\", RegisterView.as_view(), name=\"register\"),\n    path(\"login/\", LoginView.as_view(), name=\"login\"),\n    path(\"logout/\", knox_views.LogoutView.as_view(), name=\"logout\"),\n    path(\"logoutall/\", knox_views.LogoutAllView.as_view(), name=\"logoutall\"),\n]\n",
    "apps/core/models.py": "# apps/core/models.py\nfrom django.db import models\nimport uuid\n\n\n# -------------------------\n# Helpers\n# -------------------------\nclass UnmanagedModel(models.Model):\n    class Meta:\n        abstract = True\n        managed = False\n\n\n# -------------------------\n# ENUM-like choices (compat√≠vel com Postgres enum)\n# -------------------------\nORG_ROLE = (\n    (\"owner\", \"owner\"),\n    (\"admin\", \"admin\"),\n    (\"manager\", \"manager\"),\n    (\"viewer\", \"viewer\"),\n)\n\nSTORE_STATUS = (\n    (\"active\", \"active\"),\n    (\"inactive\", \"inactive\"),\n    (\"trial\", \"trial\"),\n    (\"blocked\", \"blocked\"),\n)\n\nCAMERA_STATUS = (\n    (\"online\", \"online\"),\n    (\"offline\", \"offline\"),\n    (\"unknown\", \"unknown\"),\n    (\"error\", \"error\"),\n)\n\nALERT_SEVERITY = (\n    (\"critical\", \"critical\"),\n    (\"warning\", \"warning\"),\n    (\"info\", \"info\"),\n)\n\nEVENT_STATUS = (\n    (\"open\", \"open\"),\n    (\"resolved\", \"resolved\"),\n    (\"ignored\", \"ignored\"),\n)\n\nEMPLOYEE_ROLE = (\n    (\"manager\", \"manager\"),\n    (\"cashier\", \"cashier\"),\n    (\"seller\", \"seller\"),\n    (\"security\", \"security\"),\n    (\"stock\", \"stock\"),\n    (\"other\", \"other\"),\n)\n\nLEAD_STATUS = (\n    (\"new\", \"new\"),\n    (\"contacted\", \"contacted\"),\n    (\"scheduled\", \"scheduled\"),\n    (\"no_show\", \"no_show\"),\n    (\"trial_active\", \"trial_active\"),\n    (\"converted\", \"converted\"),\n    (\"lost\", \"lost\"),\n)\n\nSUBSCRIPTION_STATUS = (\n    (\"trialing\", \"trialing\"),\n    (\"active\", \"active\"),\n    (\"past_due\", \"past_due\"),\n    (\"canceled\", \"canceled\"),\n    (\"incomplete\", \"incomplete\"),\n    (\"blocked\", \"blocked\"),\n)\n\n\n# -------------------------\n# Organization / Membership\n# -------------------------\nclass Organization(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    name = models.TextField()\n    segment = models.TextField(null=True, blank=True)\n    country = models.TextField(default=\"BR\")\n    timezone = models.TextField(default=\"America/Sao_Paulo\")\n    created_at = models.DateTimeField()\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"organizations\"\n\n\nclass OrgMember(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    org = models.ForeignKey(Organization, on_delete=models.DO_NOTHING, db_column=\"org_id\")\n    user_id = models.UUIDField()  # uuid do User Django\n    role = models.CharField(max_length=20, choices=ORG_ROLE, default=\"viewer\")\n    created_at = models.DateTimeField()\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"org_members\"\n        unique_together = ((\"org\", \"user_id\"),)\n\n\n# -------------------------\n# Stores / Zones\n# -------------------------\nclass Store(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    org = models.ForeignKey(Organization, on_delete=models.DO_NOTHING, db_column=\"org_id\")\n    code = models.TextField(null=True, blank=True)\n    name = models.TextField()\n    mall_name = models.TextField(null=True, blank=True)\n    city = models.TextField(null=True, blank=True)\n    state = models.TextField(null=True, blank=True)\n    address = models.TextField(null=True, blank=True)\n    status = models.CharField(max_length=20, choices=STORE_STATUS, default=\"trial\")\n    trial_started_at = models.DateTimeField(null=True, blank=True)\n    trial_ends_at = models.DateTimeField(null=True, blank=True)\n    blocked_reason = models.TextField(null=True, blank=True)\n    created_at = models.DateTimeField()\n    updated_at = models.DateTimeField()\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"stores\"\n\n\nclass StoreZone(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    store = models.ForeignKey(Store, on_delete=models.DO_NOTHING, db_column=\"store_id\")\n    name = models.TextField()\n    zone_type = models.TextField()\n    is_critical = models.BooleanField(default=False)\n    created_at = models.DateTimeField()\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"store_zones\"\n        unique_together = ((\"store\", \"name\"),)\n\n\n# -------------------------\n# Cameras\n# -------------------------\nclass Camera(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    store = models.ForeignKey(Store, on_delete=models.DO_NOTHING, db_column=\"store_id\")\n    zone = models.ForeignKey(StoreZone, on_delete=models.DO_NOTHING, db_column=\"zone_id\", null=True, blank=True)\n\n    name = models.TextField()\n    brand = models.TextField(null=True, blank=True)\n    model = models.TextField(null=True, blank=True)\n    ip = models.TextField(null=True, blank=True)\n    onvif = models.BooleanField(default=False)\n\n    rtsp_url = models.TextField(null=True, blank=True)\n    username = models.TextField(null=True, blank=True)\n    password = models.TextField(null=True, blank=True)\n\n    status = models.CharField(max_length=20, choices=CAMERA_STATUS, default=\"unknown\")\n    last_seen_at = models.DateTimeField(null=True, blank=True)\n    last_snapshot_url = models.TextField(null=True, blank=True)\n    last_error = models.TextField(null=True, blank=True)\n\n    created_at = models.DateTimeField()\n    updated_at = models.DateTimeField()\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"cameras\"\n\n\nclass CameraHealthLog(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    camera = models.ForeignKey(Camera, on_delete=models.DO_NOTHING, db_column=\"camera_id\")\n    checked_at = models.DateTimeField()\n    status = models.CharField(max_length=20, choices=CAMERA_STATUS)\n    latency_ms = models.IntegerField(null=True, blank=True)\n    snapshot_url = models.TextField(null=True, blank=True)\n    error = models.TextField(null=True, blank=True)\n\n    class Meta(UnmanagedModel.Meta):\n        db_table = \"camera_health_logs\"\n\n\n# -------------------------\n# Employees / Shifts / Clock\n# -------------------------\nclass Employee(UnmanagedModel):\n    id = models.UUIDField(primary_key=True, default=uuid.uuid4)\n    store = models.ForeignKey(Store, on_delete=models.DO_NOTHING, db_column=\"store_id\")\n    full_name = models.TextField()\n    email = models.TextFiel",
    "apps/core/admin.py": "# apps/core/admin.py\nfrom django.contrib import admin\nfrom . import models\n\n# Registra tudo rapidamente (para n√£o travar agora)\nadmin.site.register(models.Organization)\nadmin.site.register(models.OrgMember)\nadmin.site.register(models.Store)\nadmin.site.register(models.StoreZone)\nadmin.site.register(models.Camera)\nadmin.site.register(models.CameraHealthLog)\nadmin.site.register(models.Employee)\nadmin.site.register(models.Shift)\nadmin.site.register(models.TimeClockEntry)\nadmin.site.register(models.DetectionEvent)\nadmin.site.register(models.EventMedia)\nadmin.site.register(models.AlertRule)\nadmin.site.register(models.NotificationLog)\nadmin.site.register(models.DemoLead)\nadmin.site.register(models.OnboardingProgress)\nadmin.site.register(models.BillingCustomer)\nadmin.site.register(models.Subscription)\nadmin.site.register(models.AuditLog)\n",
    "apps/stores/models.py": "# apps/stores/models.py\n\nfrom django.db import models\nfrom django.contrib.auth.models import User\n\n\nclass Store(models.Model):\n    PLAN_CHOICES = [\n        ('trial', 'Trial'),\n        ('basic', 'B√°sico'),\n        ('pro', 'Profissional'),\n        ('enterprise', 'Enterprise'),\n    ]\n\n    STATUS_CHOICES = [\n        ('active', 'Ativa'),\n        ('inactive', 'Inativa'),\n        ('maintenance', 'Manuten√ß√£o'),\n    ]\n\n    name = models.CharField(max_length=200)\n\n    # ‚ö†Ô∏è Owner pode ser NULL no in√≠cio\n    owner = models.ForeignKey(\n        User,\n        on_delete=models.CASCADE,\n        related_name='stores',\n        null=True,\n        blank=True\n    )\n\n    description = models.TextField(blank=True, null=True)\n    address = models.TextField(blank=True, null=True)\n    city = models.CharField(max_length=100, blank=True, null=True)\n    state = models.CharField(max_length=2, blank=True, null=True)\n    phone = models.CharField(max_length=20, blank=True, null=True)\n    email = models.EmailField(blank=True, null=True)\n\n    plan = models.CharField(\n        max_length=20,\n        choices=PLAN_CHOICES,\n        default='trial'\n    )\n\n    # üî• Fonte √∫nica de verdade\n    status = models.CharField(\n        max_length=20,\n        choices=STATUS_CHOICES,\n        default='active'\n    )\n\n    created_at = models.DateTimeField(auto_now_add=True)\n    updated_at = models.DateTimeField(auto_now=True)\n\n    owner_email = models.EmailField(blank=True, null=True)\n\n    @property\n    def is_active(self):\n        \"\"\"Campo derivado: loja ativa apenas se status == active\"\"\"\n        return self.status == 'active'\n\n    def save(self, *args, **kwargs):\n        if self.owner and not self.owner_email:\n            self.owner_email = self.owner.email\n        super().save(*args, **kwargs)\n\n    def __str__(self):\n        return self.name\n",
    "apps/stores/serializers.py": "# apps/stores/serializers.py\n\nfrom rest_framework import serializers\nfrom .models import Store\n\n\nclass StoreSerializer(serializers.ModelSerializer):\n    status_display = serializers.CharField(source='get_status_display', read_only=True)\n    is_active = serializers.SerializerMethodField()\n    days_since_creation = serializers.SerializerMethodField()\n\n    class Meta:\n        model = Store\n        fields = [\n            'id',\n            'name',\n            'description',\n            'address',\n            'city',\n            'state',\n            'phone',\n            'email',\n            'plan',\n            'status',\n            'status_display',\n            'is_active',\n            'days_since_creation',\n            'owner_email',\n            'created_at',\n            'updated_at',\n        ]\n        read_only_fields = ['id', 'created_at', 'updated_at', 'owner_email', 'is_active']\n\n    def get_is_active(self, obj):\n        return obj.status == 'active'\n\n    def get_days_since_creation(self, obj):\n        from django.utils import timezone\n        if obj.created_at:\n            delta = timezone.now() - obj.created_at\n            return delta.days\n        return 0\n\n    def create(self, validated_data):\n        return super().create(validated_data)\n\n",
    "apps/stores/views.py": "# apps/stores/views.py \nfrom rest_framework import viewsets, status, permissions\nfrom rest_framework.decorators import action\nfrom rest_framework.response import Response\nfrom django.utils import timezone\nfrom datetime import timedelta\nfrom .models import Store\nfrom .serializers import StoreSerializer\n\nclass StoreViewSet(viewsets.ModelViewSet):\n    queryset = Store.objects.all()\n    serializer_class = StoreSerializer\n    permission_classes = [permissions.IsAuthenticated]\n    \n    def get_queryset(self):\n        \"\"\"Filtra apenas lojas do usu√°rio atual\"\"\"\n        user = self.request.user\n        if user.is_authenticated:\n            return Store.objects.filter(owner=self.request.user)\n        return Store.objects.none()\n    \n    def list(self, request):\n        \"\"\"Sobrescreve list para retornar formato personalizado - MANTENHA ESTE!\"\"\"\n        stores = self.get_queryset()\n        serializer = self.get_serializer(stores, many=True)\n        return Response({\n            'status': 'success',\n            'count': stores.count(),\n            'data': serializer.data,\n            'timestamp': timezone.now().isoformat()\n        })\n    \n    def perform_create(self, serializer):\n        \"\"\"Auto-popula owner_email com email do usu√°rio - ADICIONE ESTE!\"\"\"\n        serializer.save(owner=self.request.user)\n    \n    \n    @action(detail=True, methods=['get'])\n    def dashboard(self, request, pk=None):\n        \"\"\"Dashboard espec√≠fico da loja (como no seu design)\"\"\"\n        store = self.get_object()\n        \n        # ‚≠ê MOCK DATA - depois substitu√≠mos por dados reais\n        dashboard_data = {\n            'store': {\n                'id': str(store.id),\n                'name': store.name,\n                'owner_email': store.owner_email,\n                'plan': store.plan,\n                'status': 'active' if store.is_active else 'inactive',\n            },\n            'metrics': {\n                'health_score': 92,\n                'productivity': 88,\n                'idle_time': 12,\n                'visitor_flow': 1240,\n                'conversion_rate': 77.5,\n                'avg_cart_value': 89.90,\n            },\n            'insights': {\n                'peak_hour': '14:00-16:00',\n                'best_selling_zone': 'Corredor A',\n                'employee_performance': {\n                    'best': 'Maria Silva (94% produtiva)',\n                    'needs_attention': 'Jo√£o Santos (67% produtiva)'\n                },\n            },\n            'recommendations': [\n                {\n                    'id': 'staff_redistribution',\n                    'title': 'Redistribuir Equipe',\n                    'description': 'Pico de fluxo esperado √†s 12:00. Mover 2 colaboradores para o setor t√™xtil.',\n                    'priority': 'high',\n                    'action': 'redistribute_staff',\n                    'estimated_impact': 'Aumento de 15% na convers√£o',\n                },\n                {\n                    'id': 'inventory_check',\n                    'title': 'Verificar Estoque',\n                    'description': 'Produtos da linha ver√£o com baixo estoque. Reabastecer at√© sexta.',\n                    'priority': 'medium',\n                    'action': 'check_inventory',\n                    'estimated_impact': 'Evitar perda de R$ 2.400 em vendas',\n                }\n            ],\n            'alerts': [\n                {\n                    'type': 'high_idle_time',\n                    'message': 'Funcion√°rio Jo√£o teve 45min de ociosidade hoje',\n                    'severity': 'medium',\n                    'time': '10:30',\n                },\n                {\n                    'type': 'conversion_opportunity',\n                    'message': '5 clientes abandonaram carrinho no setor eletr√¥nicos',\n                    'severity': 'high',\n                    'time': '11:15',\n                }\n            ]\n        }\n        \n        return Response(dashboard_data)\n    \n    @action(detail=True, methods=['get'])\n    def live_monitor(self, request, pk=None):\n        \"\"\"Dados para monitoramento em tempo real\"\"\"\n        store = self.get_object()\n        \n        # ‚≠ê MOCK - depois vem do processamento de v√≠deo\n        monitor_data = {\n            'store': store.name,\n            'timestamp': timezone.now().isoformat(),\n            'cameras': [\n                {\n                    'id': 'cam_001',\n                    'name': 'Caixa Principal',\n                    'status': 'online',\n                    'current_viewers': 0,\n                    'events_last_hour': 12,\n                    'stream_url': f'/api/cameras/{store.id}/stream/cam_001'\n                },\n                {\n                    'id': 'cam_002',\n                    'name': 'Entrada Loja',\n                    'status': 'online',\n                    'current_viewers': 1,\n                    'events_last_hour': 47,\n                    'stream_url': f'/api/cameras/{store.id}/stream/cam_002'\n                }\n            ],\n            'current_events': [\n                {\n                    'type': 'person_detected',\n                    'camera': 'Entrada Loja',\n                    'confidence': 0.92,\n                    'timestamp': timezone.now().isoformat(),\n                },\n                {\n                    'type': 'queue_forming',\n                    'camera': 'Caixa Principal',\n                    'confidence': 0.78,\n                    'timestamp': timezone.now().isoformat(),\n                    'details': '3 pessoas na fila'\n                }\n            ]\n        }\n        \n        return Response(monitor_data)\n    \n    @action(detail=False, methods=['get'])\n    def network_dashboard(self, request):\n        \"\"\"Dashboard para redes com m√∫ltiplas lojas (seu segundo design)\"\"\"\n        stores = self.get_queryset()\n        \n        network_data = {\n            'network': {\n                'total_stores': stores.count(),\n                'active_stores': stores.filter(status='active').count(),\n                'total_visitors': 3124,\n   ",
    "apps/stores/urls.py": "# apps/stores/urls.py (crie se n√£o existe)\nfrom django.urls import path, include\nfrom rest_framework.routers import DefaultRouter\nfrom .views import StoreViewSet\n\nrouter = DefaultRouter()\nrouter.register(r'stores', StoreViewSet)\n\nurlpatterns = [\n    path('', include(router.urls)),\n]",
    "apps/cameras/views.py": "from django.utils import timezone\nfrom rest_framework import viewsets, permissions, status\nfrom rest_framework.decorators import action\nfrom rest_framework.response import Response\n\nfrom apps.core.models import Camera, CameraHealthLog\nfrom .serializers import CameraSerializer, CameraHealthLogSerializer\nfrom .services import rtsp_snapshot\n\nclass CameraViewSet(viewsets.ModelViewSet):\n    serializer_class = CameraSerializer\n    permission_classes = [permissions.IsAuthenticated]\n\n    def get_queryset(self):\n        store_id = self.request.query_params.get(\"store_id\")\n        qs = Camera.objects.all().order_by(\"-updated_at\")\n        if store_id:\n            qs = qs.filter(store_id=store_id)\n        return qs\n\n    @action(detail=True, methods=[\"post\"], url_path=\"test-snapshot\")\n    def test_snapshot(self, request, pk=None):\n        cam = self.get_object()\n\n        if not cam.rtsp_url:\n            return Response({\"detail\": \"Camera sem rtsp_url\"}, status=status.HTTP_400_BAD_REQUEST)\n\n        res = rtsp_snapshot(cam.rtsp_url)\n\n        if res.get(\"ok\"):\n            cam.status = \"online\"\n            cam.last_seen_at = timezone.now()\n            cam.last_error = None\n            # Para demo: voc√™ pode salvar last_snapshot_url como caminho local/tempor√°rio\n            cam.last_snapshot_url = res.get(\"path\")\n            cam.save(update_fields=[\"status\",\"last_seen_at\",\"last_error\",\"last_snapshot_url\",\"updated_at\"])\n\n            CameraHealthLog.objects.create(\n                camera_id=cam.id,\n                checked_at=timezone.now(),\n                status=\"online\",\n                latency_ms=res.get(\"latency_ms\"),\n                snapshot_url=cam.last_snapshot_url,\n                error=None,\n            )\n\n            return Response({\"ok\": True, \"latency_ms\": res.get(\"latency_ms\"), \"snapshot_path\": res.get(\"path\")})\n\n        cam.status = \"error\"\n        cam.last_error = res.get(\"error\")\n        cam.save(update_fields=[\"status\",\"last_error\",\"updated_at\"])\n\n        CameraHealthLog.objects.create(\n            camera_id=cam.id,\n            checked_at=timezone.now(),\n            status=\"error\",\n            latency_ms=None,\n            snapshot_url=None,\n            error=res.get(\"error\"),\n        )\n\n        return Response({\"ok\": False, \"error\": res.get(\"error\")}, status=status.HTTP_502_BAD_GATEWAY)\n\nclass CameraHealthLogViewSet(viewsets.ReadOnlyModelViewSet):\n    serializer_class = CameraHealthLogSerializer\n    permission_classes = [permissions.IsAuthenticated]\n\n    def get_queryset(self):\n        camera_id = self.request.query_params.get(\"camera_id\")\n        qs = CameraHealthLog.objects.all().order_by(\"-checked_at\")\n        if camera_id:\n            qs = qs.filter(camera_id=camera_id)\n        return qs\n",
    "apps/cameras/serializers.py": "from rest_framework import serializers\nfrom apps.core.models import Camera, CameraHealthLog\n\nclass CameraSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = Camera\n        fields = \"__all__\"\n        read_only_fields = (\"id\",\"created_at\",\"updated_at\",\"last_seen_at\",\"last_snapshot_url\",\"last_error\")\n\nclass CameraHealthLogSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = CameraHealthLog\n        fields = \"__all__\"\n        read_only_fields = (\"id\",\"checked_at\")\n",
    "apps/cameras/services.py": "import time\nimport cv2\nimport tempfile\nfrom django.utils import timezone\n\ndef rtsp_snapshot(rtsp_url: str, timeout_sec: int = 6) -> dict:\n    \"\"\"\n    Tenta capturar 1 frame do RTSP.\n    Retorna: ok, latency_ms, tmp_path (jpg) ou error.\n    \"\"\"\n    start = time.time()\n    cap = cv2.VideoCapture(rtsp_url)\n\n    # timeout manual (opencv n√£o √© perfeito com timeout)\n    deadline = start + timeout_sec\n    ok = False\n    frame = None\n\n    while time.time() < deadline:\n        ok, frame = cap.read()\n        if ok and frame is not None:\n            break\n\n    cap.release()\n\n    if not ok or frame is None:\n        return {\"ok\": False, \"error\": \"N√£o foi poss√≠vel capturar frame RTSP.\"}\n\n    latency_ms = int((time.time() - start) * 1000)\n\n    fd, path = tempfile.mkstemp(suffix=\".jpg\")\n    # fecha fd porque cv2.imwrite usa path\n    import os\n    os.close(fd)\n\n    cv2.imwrite(path, frame)\n    return {\"ok\": True, \"latency_ms\": latency_ms, \"path\": path, \"captured_at\": timezone.now()}\n",
    "apps/cameras/urls.py": "from django.urls import path, include\nfrom rest_framework.routers import DefaultRouter\nfrom .views import CameraViewSet, CameraHealthLogViewSet\n\nrouter = DefaultRouter()\nrouter.register(r\"cameras\", CameraViewSet, basename=\"cameras\")\nrouter.register(r\"camera-health-logs\", CameraHealthLogViewSet, basename=\"camera-health-logs\")\n\nurlpatterns = [\n    path(\"\", include(router.urls)),\n]\n",
    "apps/alerts/models.py": "from django.db import models\n\n# Create your models here.\n",
    "apps/alerts/serializers.py": "# apps/alerts/serializers.py\nfrom rest_framework import serializers\n\nfrom apps.core.models import (\n    DemoLead,\n    AlertRule,\n    DetectionEvent,\n    EventMedia,\n    NotificationLog,\n    JourneyEvent,\n)\n\nclass DemoLeadSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = DemoLead\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\", \"status\")\n\nclass AlertRuleSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = AlertRule\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\", \"updated_at\")\n\nclass EventMediaSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = EventMedia\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n\nclass DetectionEventSerializer(serializers.ModelSerializer):\n    media = serializers.SerializerMethodField()\n\n    class Meta:\n        model = DetectionEvent\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n\n    def get_media(self, obj):\n        qs = EventMedia.objects.filter(event_id=obj.id).order_by(\"-created_at\")\n        return EventMediaSerializer(qs, many=True).data\n\nclass NotificationLogSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = NotificationLog\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"sent_at\")\n\nclass JourneyEventSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = JourneyEvent\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n",
    "apps/alerts/services.py": "# apps/alerts/services.py\nimport requests\nfrom typing import Optional, Dict, Any\nfrom django.conf import settings\nfrom django.utils import timezone\n\n\nDEFAULT_TIMEOUT = 8\n\n\ndef _get_webhook() -> Optional[str]:\n    \"\"\"\n    Webhook √∫nico para eventos (leads, calendly, alerts, billing, etc.)\n    \"\"\"\n    return getattr(settings, \"N8N_EVENTS_WEBHOOK\", None)\n\n\ndef send_event_to_n8n(\n    *,\n    event_name: str,\n    data: Dict[str, Any],\n    event_id: Optional[str] = None,\n    lead_id: Optional[str] = None,\n    org_id: Optional[str] = None,\n    source: str = \"backend\",\n    event_version: int = 1,\n    meta: Optional[Dict[str, Any]] = None,\n    timeout: int = DEFAULT_TIMEOUT,\n) -> Dict[str, Any]:\n    \"\"\"\n    Envia um evento padronizado para o n8n.\n    - event_name: \"lead_created\", \"alert_triggered\", \"invoice_overdue\", etc.\n    - data: payload espec√≠fico do evento\n    - event_id: idealmente o UUID do JourneyEvent (idempot√™ncia)\n    - lead_id/org_id: usados para roteamento e auditoria\n    - meta: extras √∫teis (ip, user_agent, request_id, etc.)\n    \"\"\"\n    webhook = _get_webhook()\n    if not webhook:\n        return {\"ok\": False, \"error\": \"N8N_EVENTS_WEBHOOK not configured\"}\n\n    payload = {\n        \"event_id\": str(event_id) if event_id else None,\n        \"event_name\": event_name,\n        \"event_version\": event_version,\n        \"source\": source,\n        \"ts\": timezone.now().isoformat(),\n        \"lead_id\": str(lead_id) if lead_id else None,\n        \"org_id\": str(org_id) if org_id else None,\n        \"data\": data or {},\n        \"meta\": meta or {},\n    }\n\n    try:\n        r = requests.post(webhook, json=payload, timeout=timeout)\n        if r.ok:\n            try:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": r.json()}\n            except Exception:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": {\"text\": r.text}}\n        return {\"ok\": False, \"status\": r.status_code, \"error\": r.text}\n    except Exception as e:\n        return {\"ok\": False, \"error\": str(e)}\n",
    "apps/alerts/views.py": "# apps/alerts/views.py\nfrom datetime import timedelta\nfrom uuid import UUID\n\nfrom django.utils import timezone\nfrom rest_framework import viewsets, permissions, status, serializers\nfrom rest_framework.decorators import action\nfrom rest_framework.exceptions import ValidationError\nfrom rest_framework.response import Response\nfrom rest_framework.views import APIView\n\nfrom apps.core.models import (\n    DemoLead,\n    AlertRule,\n    DetectionEvent,\n    EventMedia,\n    NotificationLog,\n    Store,\n)\nfrom .serializers import (\n    DemoLeadSerializer,\n    AlertRuleSerializer,\n    DetectionEventSerializer,\n    EventMediaSerializer,\n    NotificationLogSerializer,\n)\nfrom .services import send_event_to_n8n\n\nfrom apps.core.models import JourneyEvent\nfrom .serializers import JourneyEventSerializer\nfrom django.db.utils import DataError\n# =========================\n# CORE STORES (UUID) - para o frontend filtrar alerts corretamente\n# GET /api/alerts/stores/\n# =========================\nclass CoreStoreSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = Store\n        fields = (\"id\", \"name\")\n\n\nclass CoreStoreListView(APIView):\n    permission_classes = [permissions.IsAuthenticated]\n\n    def get(self, request):\n        qs = Store.objects.all().order_by(\"name\")\n        return Response(CoreStoreSerializer(qs, many=True).data)\n\n\n# =========================\n# Helpers\n# =========================\ndef is_uuid(value: str) -> bool:\n    try:\n        UUID(str(value))\n        return True\n    except Exception:\n        return False\n\n\ndef require_uuid_param(name: str, value: str):\n    if not is_uuid(value):\n        raise ValidationError({name: f'{name} deve ser um UUID v√°lido (core.Store). Recebido: \"{value}\".'})\n\n\n# =========================\n# DEMO LEAD (FORM P√öBLICO) ‚Äî Op√ß√£o A (DEDUPE por email/whatsapp)\n# =========================\nclass DemoLeadCreateView(APIView):\n    permission_classes = [permissions.AllowAny]\n\n    def post(self, request):\n        now = timezone.now()\n\n        email = (request.data.get(\"email\") or \"\").strip()\n        whatsapp = (request.data.get(\"whatsapp\") or \"\").strip()\n\n        active_statuses = [\"new\", \"contacted\", \"scheduled\"]\n        existing = None\n\n        if email:\n            existing = (\n                DemoLead.objects.filter(email__iexact=email, status__in=active_statuses)\n                .order_by(\"-created_at\")\n                .first()\n            )\n\n        if not existing and whatsapp:\n            existing = (\n                DemoLead.objects.filter(whatsapp=whatsapp, status__in=active_statuses)\n                .order_by(\"-created_at\")\n                .first()\n            )\n\n        if existing:\n            # 1) grava JourneyEvent\n            je = JourneyEvent.objects.create(\n                lead_id=existing.id,\n                org_id=None,\n                event_name=\"lead_duplicate_attempt\",\n                payload={\n                    \"source\": \"demo_form\",\n                    \"reason\": \"duplicate_active_lead\",\n                    \"status\": existing.status,\n                    \"email\": email or existing.email,\n                    \"whatsapp\": whatsapp or existing.whatsapp,\n                },\n                created_at=now,\n            )\n\n            # 2) dispara n8n (webhook √∫nico)\n            # Obs: n√£o pode quebrar o fluxo do usu√°rio\n            try:\n                send_event_to_n8n(\n                    event_name=\"lead_duplicate_attempt\",\n                    event_id=str(je.id),\n                    lead_id=str(existing.id),\n                    org_id=None,\n                    source=\"backend\",\n                    data={\n                        \"lead_id\": str(existing.id),\n                        \"status\": existing.status,\n                        \"email\": existing.email,\n                        \"whatsapp\": existing.whatsapp,\n                        \"created_at\": existing.created_at.isoformat() if existing.created_at else None,\n                    },\n                    meta={\n                        \"ip\": request.META.get(\"REMOTE_ADDR\"),\n                        \"user_agent\": request.META.get(\"HTTP_USER_AGENT\"),\n                    },\n                )\n            except Exception:\n                pass\n\n            return Response(DemoLeadSerializer(existing).data, status=status.HTTP_200_OK)\n\n        # -------------------------\n        # 1) Cria lead\n        # -------------------------\n        serializer = DemoLeadSerializer(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        lead = serializer.save(status=\"new\", created_at=now)\n\n        # -------------------------\n        # 2) JourneyEvent: lead_created\n        # -------------------------\n        je = JourneyEvent.objects.create(\n            lead_id=lead.id,\n            org_id=None,\n            event_name=\"lead_created\",\n            payload={\n                \"source\": \"demo_form\",\n                \"lead_id\": str(lead.id),\n                \"email\": lead.email,\n                \"whatsapp\": lead.whatsapp,\n                \"operation_type\": getattr(lead, \"operation_type\", None),\n                \"stores_range\": getattr(lead, \"stores_range\", None),\n                \"cameras_range\": getattr(lead, \"cameras_range\", None),\n                \"primary_goal\": getattr(lead, \"primary_goal\", None),\n                \"primary_goals\": getattr(lead, \"primary_goals\", None),\n                \"qualified_score\": getattr(lead, \"qualified_score\", None),\n            },\n            created_at=now,\n        )\n\n        # -------------------------\n        # 3) Dispara n8n (webhook √∫nico)\n        # -------------------------\n        send_event_to_n8n(\n            event_name=\"lead_created\",\n            event_id=str(je.id),              # <- idempot√™ncia\n            lead_id=str(lead.id),\n            org_id=None,\n            source=\"backend\",\n            data={\n                \"lead_id\": str(lead.id),\n                \"contact_name\": lead.contact_name,\n                \"email\": lead.email,\n                \"whatsapp\": lead.whatsapp,\n     ",
    "apps/alerts/urls.py": "# apps/alerts/urls.py\nfrom django.urls import path, include\nfrom rest_framework.routers import DefaultRouter\nfrom .views import (\n    DemoLeadCreateView,\n    AlertRuleViewSet,\n    DetectionEventViewSet,\n    NotificationLogViewSet,\n    CoreStoreListView,\n    JourneyEventViewSet,\n)\n\nrouter = DefaultRouter()\nrouter.register(r\"alert-rules\", AlertRuleViewSet, basename=\"alert-rules\")\nrouter.register(r\"events\", DetectionEventViewSet, basename=\"events\")\nrouter.register(r\"notification-logs\", NotificationLogViewSet, basename=\"notification-logs\")\nrouter.register(r\"journey-events\", JourneyEventViewSet, basename=\"journey-events\")\n\nurlpatterns = [\n    path(\"stores/\", CoreStoreListView.as_view(), name=\"alerts-core-stores\"),\n    path(\"demo-leads/\", DemoLeadCreateView.as_view(), name=\"demo-leads\"),\n    path(\"\", include(router.urls)),\n]\n",
    "apps/edge/models.py": "from django.db import models\n\nclass EdgeEventReceipt(models.Model):\n    receipt_id = models.CharField(max_length=128, unique=True)\n    event_name = models.CharField(max_length=64)\n    source = models.CharField(max_length=32, default=\"edge\")\n    store_id = models.CharField(max_length=64, null=True, blank=True)\n    payload = models.JSONField(default=dict)\n    created_at = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return f\"{self.event_name} {self.receipt_id[:10]}\"\n\n",
    "apps/edge/serializers.py": "from rest_framework import serializers\n\n\nclass EdgeEventSerializer(serializers.Serializer):\n    event_name = serializers.CharField()\n    ts = serializers.CharField(required=False)\n    source = serializers.CharField(required=False)\n    data = serializers.DictField(required=False)\n    meta = serializers.DictField(required=False)\n    receipt_id = serializers.CharField(required=False, allow_blank=True)\n\n    event_version = serializers.IntegerField(required=False)\n    event_id = serializers.CharField(required=False, allow_null=True)\n    org_id = serializers.CharField(required=False, allow_null=True)\n",
    "apps/edge/permissions.py": "# apps/edge/permissions.py\nimport os\nfrom rest_framework.permissions import BasePermission\n\n\nclass EdgeTokenPermission(BasePermission):\n    \"\"\"\n    Valida header X-EDGE-TOKEN contra EDGE_AGENT_TOKEN do .env/settings.\n    \"\"\"\n\n    def has_permission(self, request, view):\n        expected = os.getenv(\"EDGE_AGENT_TOKEN\") or \"\"\n        provided = request.headers.get(\"X-EDGE-TOKEN\") or \"\"\n        return bool(expected) and (provided == expected)\n",
    "apps/edge/views.py": "# apps/edge/views.py\nfrom django.conf import settings\nfrom django.contrib.auth import get_user_model\n\nfrom rest_framework.views import APIView\nfrom rest_framework.response import Response\nfrom rest_framework import status\nfrom rest_framework.test import APIRequestFactory, force_authenticate\n\nfrom .serializers import EdgeEventSerializer\nfrom .models import EdgeEventReceipt\nfrom .permissions import EdgeTokenPermission\n\nfrom apps.alerts.views import AlertRuleViewSet\n\nclass EdgeEventsIngestView(APIView):\n    \"\"\"\n    POST /api/edge/events/\n    Recebe envelope do Edge Agent:\n      - edge_heartbeat\n      - edge_metric_bucket\n      - alert\n    Faz:\n      - valida envelope\n      - dedupe por receipt_id (EdgeEventReceipt)\n      - encaminha \"alert\" para AlertRuleViewSet.ingest (internamente)\n      - para edge_metric_bucket / heartbeat: s√≥ registra receipt e retorna ok\n    \"\"\"\n    authentication_classes = []\n    permission_classes = [EdgeTokenPermission]\n\n    def _get_service_user(self):\n        \"\"\"\n        Usu√°rio interno que ser√° usado para chamar o ingest do Alerts.\n        \"\"\"\n        username = getattr(settings, \"EDGE_SERVICE_USERNAME\", \"edge-agent\")\n        User = get_user_model()\n        u = User.objects.filter(username=username).first()\n        return u\n\n    def post(self, request):\n        ser = EdgeEventSerializer(data=request.data)\n        ser.is_valid(raise_exception=True)\n        validated = ser.validated_data\n        payload = request.data  # salva raw json\n\n        event_name = validated.get(\"event_name\")\n        source = validated.get(\"source\") or \"edge\"\n        receipt_id = validated.get(\"receipt_id\") or \"\"\n        data = validated.get(\"data\") or {}\n        store_id = data.get(\"store_id\")\n\n        # --- dedupe por receipt_id ---\n        if receipt_id:\n            _, created = EdgeEventReceipt.objects.get_or_create(\n                receipt_id=receipt_id,\n                defaults={\n                    \"event_name\": event_name,\n                    \"source\": source,\n                    \"store_id\": store_id,\n                    \"payload\": payload,\n                },\n            )\n            if not created:\n                return Response({\"ok\": True, \"deduped\": True}, status=status.HTTP_200_OK)\n\n        # --- encaminhar ALERT do edge para o ingest do Alerts ---\n        if event_name == \"alert\":\n            ingest_payload = {\n                \"store_id\": data.get(\"store_id\"),\n                \"camera_id\": data.get(\"camera_id\"),\n                \"zone_id\": data.get(\"zone_id\"),\n                \"event_type\": data.get(\"event_type\") or data.get(\"type\"),\n                \"severity\": data.get(\"severity\"),\n                \"title\": data.get(\"title\") or \"Alerta\",\n                \"description\": data.get(\"description\") or data.get(\"message\") or \"\",\n                \"metadata\": data.get(\"metadata\") or {},\n                \"occurred_at\": data.get(\"occurred_at\"),\n                \"clip_url\": data.get(\"clip_url\"),\n                \"snapshot_url\": data.get(\"snapshot_url\"),\n                \"destinations\": data.get(\"destinations\") or {},\n            }\n\n            service_user = self._get_service_user()\n            if service_user is None:\n                # se n√£o existir user, falha expl√≠cita para voc√™ corrigir r√°pido\n                return Response(\n                    {\"detail\": \"EDGE service user not found. Create user 'edge-agent' or set EDGE_SERVICE_USERNAME.\"},\n                    status=status.HTTP_500_INTERNAL_SERVER_ERROR,\n                )\n\n            factory = APIRequestFactory()\n            drf_req = factory.post(\"/api/alerts/alert-rules/ingest/\", ingest_payload, format=\"json\")\n            force_authenticate(drf_req, user=service_user)\n\n            ingest_view = AlertRuleViewSet.as_view({\"post\": \"ingest\"})\n            return ingest_view(drf_req)\n\n        # por enquanto: heartbeat/bucket aceita e responde ok\n        return Response({\"ok\": True}, status=status.HTTP_200_OK)\n",
    "apps/edge/urls.py": "from django.urls import path\nfrom .views import EdgeEventsIngestView\n\nurlpatterns = [\n    path(\"events/\", EdgeEventsIngestView.as_view(), name=\"edge-events\"),\n]\n",
    "frontend/src/App.tsx": "import { Routes, Route, Navigate } from \"react-router-dom\"\nimport PrivateRoute from \"./components/PrivateRoute\"\nimport Layout from \"./components/Layout/Layout\"\n\nimport HomePage from \"./pages/Home/Home\"\nimport Login from \"./pages/Login/Login\"\nimport AgendarDemo from \"./pages/AgendarDemo/AgendarDemo\"\n\nimport Dashboard from \"./pages/Dashboard/Dashboard\"\nimport Stores from \"./pages/Stores/Stores\"\nimport Analytics from \"./pages/Analytics/Analytics\"\nimport Cameras from \"./pages/Cameras/Cameras\"\nimport Alerts from \"./pages/Alerts/Alerts\"\nimport Settings from \"./pages/Settings/Settings\"\nimport ProfilePage from \"./pages/Profile/Profile\"\n\n// ‚úÖ Alerts stack\nimport AlertRules from \"./pages/AlertRules/AlertRules\"\nimport NotificationLogs from \"./pages/NotificationLogs/NotificationLogs\"\n\n// üÜï Onboarding / Register (front-only)\nimport Register from \"./pages/Register/Register\"\nimport Onboarding from \"./pages/Onboarding/Onboarding\"\nimport OnboardingSuccess from \"./pages/Onboarding/OnboardingSuccess\"\n\nfunction App() {\n  return (\n    <Routes>\n      {/* Rotas p√∫blicas */}\n      <Route path=\"/\" element={<HomePage />} />\n      <Route path=\"/login\" element={<Login />} />\n      <Route path=\"/agendar-demo\" element={<AgendarDemo />} />\n\n      {/* üÜï Registro + Onboarding (p√∫blico, sem backend por enquanto) */}\n      <Route path=\"/register\" element={<Register />} />\n      <Route path=\"/onboarding\" element={<Onboarding />} />\n      <Route path=\"/onboarding/success\" element={<OnboardingSuccess />} />\n\n      {/* Rotas protegidas */}\n      <Route\n        path=\"/app\"\n        element={\n          <PrivateRoute>\n            <Layout />\n          </PrivateRoute>\n        }\n      >\n        <Route index element={<Navigate to=\"/app/dashboard\" replace />} />\n        <Route path=\"dashboard\" element={<Dashboard />} />\n        <Route path=\"stores\" element={<Stores />} />\n        <Route path=\"analytics\" element={<Analytics />} />\n        <Route path=\"cameras\" element={<Cameras />} />\n        <Route path=\"alerts\" element={<Alerts />} />\n\n        {/* ‚úÖ Alerts stack */}\n        <Route path=\"alert-rules\" element={<AlertRules />} />\n        <Route path=\"notification-logs\" element={<NotificationLogs />} />\n\n        <Route path=\"settings\" element={<Settings />} />\n        <Route path=\"profile\" element={<ProfilePage />} />\n      </Route>\n\n      {/* Compat: se algum lugar ainda manda pra rotas sem /app */}\n      <Route path=\"/dashboard\" element={<Navigate to=\"/app/dashboard\" replace />} />\n      <Route path=\"/stores\" element={<Navigate to=\"/app/stores\" replace />} />\n      <Route path=\"/analytics\" element={<Navigate to=\"/app/analytics\" replace />} />\n      <Route path=\"/cameras\" element={<Navigate to=\"/app/cameras\" replace />} />\n      <Route path=\"/alerts\" element={<Navigate to=\"/app/alerts\" replace />} />\n      <Route path=\"/settings\" element={<Navigate to=\"/app/settings\" replace />} />\n\n      {/* ‚úÖ Redirects Alerts */}\n      <Route path=\"/alert-rules\" element={<Navigate to=\"/app/alert-rules\" replace />} />\n      <Route path=\"/notification-logs\" element={<Navigate to=\"/app/notification-logs\" replace />} />\n\n      {/* ‚úÖ Redirects Onboarding (opcional, caso algu√©m aponte errado) */}\n      <Route path=\"/onboarding-success\" element={<Navigate to=\"/onboarding/success\" replace />} />\n\n      {/* Fallback */}\n      <Route path=\"*\" element={<Navigate to=\"/\" replace />} />\n    </Routes>\n  )\n}\n\nexport default App\n",
    "frontend/src/main.tsx": "// src/main.tsx\nimport React from \"react\"\nimport ReactDOM from \"react-dom/client\"\nimport { BrowserRouter } from \"react-router-dom\"\nimport { QueryClient, QueryClientProvider } from \"@tanstack/react-query\"\nimport { HelmetProvider } from \"react-helmet-async\"\nimport { Toaster } from \"react-hot-toast\"\n\nimport { AuthProvider } from \"./contexts/AuthContext\"\nimport { AgentProvider } from \"./contexts/AgentContext\"\nimport { alertsService } from \"./services/alerts\"\n\nimport App from \"./App\"\nimport \"./index.css\"\n\ndeclare global {\n  interface Window {\n    alertsService: typeof alertsService\n  }\n}\n\nwindow.alertsService = alertsService\n\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      refetchOnWindowFocus: false,\n      retry: 1,\n    },\n  },\n})\n\nReactDOM.createRoot(document.getElementById(\"root\")!).render(\n  <React.StrictMode>\n    <HelmetProvider>\n      <QueryClientProvider client={queryClient}>\n        <BrowserRouter>\n          <AuthProvider>\n            <AgentProvider>\n              <App />\n              <Toaster\n                position=\"top-right\"\n                toastOptions={{\n                  duration: 4000,\n                  style: {\n                    background: \"#363636\",\n                    color: \"#fff\",\n                  },\n                  success: {\n                    duration: 3000,\n                    iconTheme: {\n                      primary: \"green\",\n                      secondary: \"black\",\n                    },\n                  },\n                }}\n              />\n            </AgentProvider>\n          </AuthProvider>\n        </BrowserRouter>\n      </QueryClientProvider>\n    </HelmetProvider>\n  </React.StrictMode>\n)\n",
    "frontend/src/services/api.ts": "// src/services/api.ts\nimport axios from \"axios\"\n\nconst API_BASE_URL = \"http://localhost:8000/api\"\n\nconst getTokenFromStorage = (): string | null => {\n  return localStorage.getItem(\"authToken\")\n}\n\nconst api = axios.create({\n  baseURL: API_BASE_URL,\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n  timeout: 10000,\n  withCredentials: false, // ‚úÖ Knox n√£o precisa de cookies\n})\n\n// Request interceptor\napi.interceptors.request.use(\n  (config) => {\n    const token = getTokenFromStorage()\n\n    // ‚úÖ Axios v1: headers pode ser AxiosHeaders (tem .set)\n    if (token) {\n      if (config.headers && typeof (config.headers as any).set === \"function\") {\n        ;(config.headers as any).set(\"Authorization\", `Token ${token}`)\n      } else {\n        config.headers = config.headers ?? {}\n        ;(config.headers as any)[\"Authorization\"] = `Token ${token}`\n      }\n    } else {\n      // remove Authorization se n√£o tiver token\n      if (config.headers && typeof (config.headers as any).delete === \"function\") {\n        ;(config.headers as any).delete(\"Authorization\")\n      } else if (config.headers) {\n        delete (config.headers as any)[\"Authorization\"]\n      }\n    }\n\n    // ‚úÖ DEBUG depois de setar token (agora √© real)\n    console.log(\"üîµ API Request:\", {\n      url: `${config.baseURL}${config.url}`,\n      method: config.method,\n      authHeader:\n        config.headers && typeof (config.headers as any).get === \"function\"\n          ? (config.headers as any).get(\"Authorization\")\n          : (config.headers as any)?.Authorization,\n      data: config.data,\n    })\n\n    return config\n  },\n  (error) => {\n    console.error(\"üî¥ API Request Error:\", error)\n    return Promise.reject(error)\n  }\n)\n\n// Response interceptor\napi.interceptors.response.use(\n  (response) => {\n    console.log(\"üü¢ API Response:\", {\n      url: response.config.url,\n      status: response.status,\n    })\n    return response\n  },\n  (error) => {\n    console.error(\"üî¥ API Response Error:\", {\n      url: error.config?.url,\n      status: error.response?.status,\n      data: error.response?.data,\n      message: error.message,\n    })\n    return Promise.reject(error)\n  }\n)\n\nexport default api\n",
    "frontend/src/services/alerts.ts": "// src/services/alerts.ts\nimport api from \"./api\"\n\nexport type AlertChannel = \"dashboard\" | \"email\" | \"whatsapp\"\n\nexport interface AlertRule {\n  id: string\n  // backend (DRF) normalmente retorna \"store\" (FK), mas vamos aceitar os 2\n  store?: string\n  store_id?: string\n\n  zone?: string | null\n  zone_id?: string | null\n\n  type: string\n  severity: \"critical\" | \"warning\" | \"info\"\n  cooldown_minutes: number\n  active: boolean\n\n  channels: {\n    dashboard: boolean\n    email: boolean\n    whatsapp: boolean\n  } | null\n\n  threshold?: any\n  created_at: string\n  updated_at: string\n}\n\nexport interface DetectionEvent {\n  id: string\n  store_id: string\n  camera_id?: string | null\n  zone_id?: string | null\n  type: string\n  severity: string\n  status: \"open\" | \"resolved\" | \"ignored\"\n  title: string\n  description: string\n  occurred_at: string\n  resolved_at?: string | null\n  resolved_by_user_id?: string | null\n  suppressed_by_rule_id?: string | null\n  suppressed_reason?: string | null\n  metadata?: any\n  created_at: string\n  media?: EventMedia[]\n}\n\nexport interface EventMedia {\n  id: string\n  event_id: string\n  media_type: \"clip\" | \"snapshot\"\n  url: string\n  created_at: string\n}\n\nexport interface NotificationLog {\n  id: string\n  store_id: string\n  event_id?: string | null\n  rule_id?: string | null\n  channel: AlertChannel\n  destination?: string | null\n  provider: string\n  status: \"sent\" | \"queued\" | \"failed\" | \"suppressed\"\n  error?: string | null\n  provider_message_id?: string | null\n  sent_at: string\n}\n\nexport interface AlertIngestPayload {\n  store_id: string\n  camera_id?: string\n  zone_id?: string\n  event_type: string\n  severity: string\n  title?: string\n  message?: string\n  description?: string\n  occurred_at?: string\n  clip_url?: string\n  snapshot_url?: string\n  metadata?: any\n  destinations?: {\n    email?: string | null\n    whatsapp?: string | null\n  }\n}\n\ntype CoreStore = { id: string; name: string }\n\n// helper: normaliza {results: []} | {data: []} | []\nfunction normalizeArray<T = any>(input: any): T[] {\n  if (!input) return []\n  if (Array.isArray(input)) return input\n  if (Array.isArray(input.results)) return input.results\n  if (Array.isArray(input.data)) return input.data\n  return []\n}\n\n// helper: normaliza store_id de regra (store ou store_id)\nfunction getRuleStoreId(rule: any): string | undefined {\n  return rule?.store_id || rule?.store\n}\n\nexport const alertsService = {\n  // =====================\n  // ALERT RULES (CRUD)\n  // =====================\n\n  async listRules(storeId?: string): Promise<AlertRule[]> {\n    const params = storeId ? { store_id: storeId } : undefined\n    const res = await api.get(\"/alerts/alert-rules/\", { params })\n    return normalizeArray<AlertRule>(res.data).map((r: any) => ({\n      ...r,\n      store_id: getRuleStoreId(r),\n      zone_id: r?.zone_id ?? r?.zone ?? null,\n    }))\n  },\n\n  async getRule(id: string): Promise<AlertRule> {\n    const res = await api.get(`/alerts/alert-rules/${id}/`)\n    const r: any = res.data\n    return {\n      ...r,\n      store_id: getRuleStoreId(r),\n      zone_id: r?.zone_id ?? r?.zone ?? null,\n    }\n  },\n\n  // IMPORTANTE: enviar \"store\" (FK) e n√£o \"store_id\"\n  async createRule(payload: Partial<AlertRule> & { store_id?: string }): Promise<AlertRule> {\n    const body: any = {\n      ...payload,\n      store: payload.store ?? payload.store_id, // <- aqui\n      zone: payload.zone ?? payload.zone_id ?? null,\n    }\n    delete body.store_id\n    delete body.zone_id\n\n    const res = await api.post(\"/alerts/alert-rules/\", body)\n    const r: any = res.data\n    return {\n      ...r,\n      store_id: getRuleStoreId(r),\n      zone_id: r?.zone_id ?? r?.zone ?? null,\n    }\n  },\n\n  async updateRule(id: string, payload: Partial<AlertRule> & { store_id?: string }): Promise<AlertRule> {\n    const body: any = {\n      ...payload,\n      ...(payload.store || payload.store_id ? { store: payload.store ?? payload.store_id } : {}),\n      ...(payload.zone || payload.zone_id ? { zone: payload.zone ?? payload.zone_id } : {}),\n    }\n    delete body.store_id\n    delete body.zone_id\n\n    const res = await api.patch(`/alerts/alert-rules/${id}/`, body)\n    const r: any = res.data\n    return {\n      ...r,\n      store_id: getRuleStoreId(r),\n      zone_id: r?.zone_id ?? r?.zone ?? null,\n    }\n  },\n\n  async deleteRule(id: string): Promise<void> {\n    await api.delete(`/alerts/alert-rules/${id}/`)\n  },\n\n  // =====================\n  // INGEST (CORE)\n  // =====================\n\n  async ingest(payload: AlertIngestPayload) {\n    const res = await api.post(\"/alerts/alert-rules/ingest/\", payload)\n    return res.data as {\n      event: DetectionEvent\n      n8n: any\n      suppressed: boolean\n    }\n  },\n\n  // =====================\n  // DETECTION EVENTS\n  // =====================\n\n  async listEvents(params?: {\n    store_id?: string\n    status?: \"open\" | \"resolved\" | \"ignored\"\n  }): Promise<DetectionEvent[]> {\n    const res = await api.get(\"/alerts/events/\", { params })\n    return normalizeArray<DetectionEvent>(res.data)\n  },\n\n  async resolveEvent(eventId: string): Promise<DetectionEvent> {\n    const res = await api.post(`/alerts/events/${eventId}/resolve/`)\n    return res.data\n  },\n\n  async ignoreEvent(eventId: string): Promise<DetectionEvent> {\n    const res = await api.post(`/alerts/events/${eventId}/ignore/`)\n    return res.data\n  },\n\n  async addEventMedia(eventId: string, media: Partial<EventMedia>) {\n    const res = await api.post(`/alerts/events/${eventId}/media/`, media)\n    return res.data\n  },\n\n  // =====================\n  // NOTIFICATION LOGS\n  // =====================\n\n  async listLogs(params?: { store_id?: string; event_id?: string }): Promise<NotificationLog[]> {\n    const res = await api.get(\"/alerts/notification-logs/\", { params })\n    return normalizeArray<NotificationLog>(res.data)\n  },\n\n  // =====================\n  // CORE STORES (UUID) - usado na UI de alertas\n  // =====================\n\n  async listCoreStores(): Promise<CoreStore[]> {\n    const res = await api.get(\"/alerts/stores/\")\n    retu",
    "frontend/src/services/stores.ts": "// src/services/stores.ts\nimport api from './api';\nimport type { StoreDashboard } from '../types/dashboard';\n\nexport type StoreStatus = 'active' | 'inactive' | 'maintenance';\nexport type StorePlan = 'trial' | 'basic' | 'pro' | 'enterprise';\n\nexport interface Store {\n  id: string;\n  name: string;\n  description?: string;\n  address?: string;\n  city?: string;\n  state?: string;\n  phone?: string;\n  email?: string;\n  plan: StorePlan;\n  status: StoreStatus;\n  created_at: string;\n  updated_at: string;\n  owner_email: string;\n}\n\ntype StoreWriteFields = {\n  name: string;\n  description?: string;\n  address?: string;\n  city?: string;\n  state?: string;\n  phone?: string;\n  email?: string;\n  status?: StoreStatus;\n};\n\nexport type CreateStorePayload = StoreWriteFields;\nexport type UpdateStorePayload = StoreWriteFields;\n\nexport interface StoreMetrics {\n  total_cameras: number;\n  active_cameras: number;\n  today_events: number;\n  avg_customer_count: number;\n  peak_hour: string;\n  alerts_today: number;\n}\n\nexport interface NetworkDashboard {\n  total_stores: number;\n  total_cameras: number;\n  active_alerts: number;\n  stores: Array<{\n    id: string;\n    name: string;\n    status: string;\n    camera_count: number;\n    last_activity: string;\n  }>;\n}\n\n// Fun√ß√µes auxiliares (n√£o exportadas)\nconst getMockDashboard = (storeId: string): StoreDashboard => {\n  console.log('üîÑ Usando dados mock para dashboard');\n  \n  const mockNames = ['Loja Principal', 'Filial Centro', 'Loja Shopping'];\n  const mockSectors = ['Setor A', 'Setor B', 'Setor C', 'Setor D'];\n  const employees = ['Maria Silva', 'Jo√£o Santos', 'Ana Oliveira', 'Pedro Costa'];\n  \n  return {\n    store: {\n      id: storeId,\n      name: mockNames[Math.floor(Math.random() * mockNames.length)],\n      owner_email: \"user@example.com\",\n      plan: [\"trial\", \"basic\", \"pro\"][Math.floor(Math.random() * 3)],\n      status: \"active\"\n    },\n    metrics: {\n      health_score: 80 + Math.floor(Math.random() * 20),\n      productivity: 70 + Math.floor(Math.random() * 25),\n      idle_time: 10 + Math.floor(Math.random() * 15),\n      visitor_flow: 800 + Math.floor(Math.random() * 400),\n      conversion_rate: 55 + Math.random() * 30,\n      avg_cart_value: 80 + Math.random() * 70\n    },\n    insights: {\n      peak_hour: `${10 + Math.floor(Math.random() * 6)}:00-${12 + Math.floor(Math.random() * 6)}:00`,\n      best_selling_zone: mockSectors[Math.floor(Math.random() * mockSectors.length)],\n      employee_performance: {\n        best: `${employees[Math.floor(Math.random() * employees.length)]} (${85 + Math.floor(Math.random() * 15)}%)`,\n        needs_attention: `${employees[Math.floor(Math.random() * employees.length)]} (${50 + Math.floor(Math.random() * 20)}%)`\n      }\n    },\n    recommendations: [\n      {\n        id: \"rec_1\",\n        title: \"Otimizar hor√°rios de pico\",\n        description: \"Ajustar escalas para cobrir o hor√°rio de maior movimento\",\n        priority: [\"high\", \"medium\", \"low\"][Math.floor(Math.random() * 3)],\n        action: \"adjust_schedules\",\n        estimated_impact: \"Aumento de 15-25% na produtividade\"\n      },\n      {\n        id: \"rec_2\",\n        title: \"Repor estoque cr√≠tico\",\n        description: \"Produtos mais vendidos com estoque abaixo do m√≠nimo\",\n        priority: [\"high\", \"medium\", \"low\"][Math.floor(Math.random() * 3)],\n        action: \"restock\",\n        estimated_impact: `Evitar perda de R$ ${(2000 + Math.random() * 3000).toFixed(0)} em vendas`\n      },\n      {\n        id: \"rec_3\",\n        title: \"Treinamento de equipe\",\n        description: \"Capacita√ß√£o para melhorar atendimento ao cliente\",\n        priority: [\"high\", \"medium\", \"low\"][Math.floor(Math.random() * 3)],\n        action: \"training\",\n        estimated_impact: \"Aumento de 10% na taxa de convers√£o\"\n      }\n    ],\n    alerts: [\n      {\n        type: \"high_idle_time\",\n        message: \"Funcion√°rio com tempo ocioso acima da m√©dia\",\n        severity: \"medium\",\n        time: new Date().toISOString()\n      },\n      {\n        type: \"low_conversion\",\n        message: \"Taxa de convers√£o abaixo da m√©dia hist√≥rica\",\n        severity: \"high\",\n        time: new Date(Date.now() - 3600000).toISOString()\n      }\n    ]\n  };\n};\n\nconst omitEmpty = <T extends Record<string, unknown>>(payload: T): Partial<T> => {\n  const result: Partial<T> = {};\n\n  (Object.keys(payload) as Array<keyof T>).forEach((key) => {\n    const value = payload[key];\n    if (value === undefined || value === null) return;\n    if (typeof value === 'string' && value === '') return;\n    result[key] = value;\n  });\n\n  return result;\n};\n\nexport const storesService = {\n  // Listar todas as lojas do usu√°rio\n  async getStores(): Promise<Store[]> {\n    console.log('üîÑ Buscando lojas...');\n    try {\n      const response = await api.get('/v1/stores/');\n      console.log('üì¶ Resposta completa:', response);\n      \n      // A API retorna {data: [...]}\n      const stores = response.data.data || response.data;\n      console.log(`‚úÖ Encontradas ${stores?.length || 0} lojas`);\n      \n      return stores || [];\n    } catch (error) {\n      console.error('‚ùå Erro ao buscar lojas:', error);\n      throw error;\n    }\n  },\n\n  // Obter dashboard completo (novo formato)\n  async getStoreDashboard(storeId: string): Promise<StoreDashboard> {\n    console.log(`üîÑ Buscando dashboard para loja ${storeId}`);\n    \n    try {\n      const response = await api.get(`/v1/stores/${storeId}/dashboard/`);\n      console.log('‚úÖ Dashboard response:', response.data);\n      return response.data;\n    } catch (error) {\n      console.error('‚ùå Erro ao buscar dashboard:', error);\n      \n      // Fallback com dados mock\n      return getMockDashboard(storeId);\n    }\n  },\n\n  // Obter m√©tricas no formato antigo (para compatibilidade se necess√°rio)\n  async getStoreMetrics(storeId: string): Promise<StoreMetrics> {\n    const dashboard = await this.getStoreDashboard(storeId);\n    \n    // Converter do novo formato para o formato antigo\n    return {\n      total_cameras: 4,\n      active_cameras: 3,\n      today_events: Math.round(",
    "edge-agent\\src\\__init__.py": "",
    "edge-agent\\src\\agent\\__init__.py": "",
    "edge-agent\\src\\agent\\lifecycle.py": "import time\nfrom typing import List\n\nfrom ..storage.sqlite_queue import SqliteQueue\nfrom ..transport.api_client import ApiClient\nfrom ..vision.aggregations import MetricAggregator\nfrom ..vision.rules import RuleEngine\nfrom ..events.builder import build_envelope\nfrom ..events.receipts import compute_receipt_id\n\n\ndef run_agent(settings):\n    \"\"\"\n    Loop principal do Edge Agent (v1):\n    - sobe workers de c√¢mera\n    - l√™ frames\n    - detecta pessoas (YOLO)\n    - update_metrics() por c√¢mera (ROI/checkout/entrada)\n    - agrega por minuto (bucket 60s)\n    - gera edge_metric_bucket + alert\n    - outbox sqlite + flush via ApiClient\n    \"\"\"\n\n    # --- outbox ---\n    queue = SqliteQueue(\n        path=settings.buffer_sqlite_path\n        #max_items=settings.max_queue_size,\n    )\n\n\n    # --- transport ---\n    api = ApiClient(\n        base_url=settings.cloud_base_url,\n        token=settings.cloud_token,\n        timeout=settings.cloud_timeout,\n    )\n\n    # --- aggregation + rules ---\n    aggregator = MetricAggregator(bucket_seconds=60)\n    rules = RuleEngine()\n\n    # --- camera workers + detector ---\n    from ..camera.rtsp import RtspCameraWorker  # import local\n    from ..vision.detector import PersonDetector\n\n    detector = PersonDetector(\n        weights_path=settings.yolo_weights_path,\n        conf=settings.conf,\n        iou=settings.iou,\n        device=settings.device,\n    )\n\n    workers: List[RtspCameraWorker] = []\n    for cam in settings.cameras:\n        w = RtspCameraWorker(\n            camera_id=cam.camera_id,\n            name=cam.name,\n            rtsp_url=cam.rtsp_url,\n            roi_config_path=cam.roi_config,\n            target_width=settings.target_width,\n            fps_limit=settings.fps_limit,\n            frame_skip=settings.frame_skip,\n        )\n        w.start()\n        workers.append(w)\n\n    last_flush = 0.0\n    last_heartbeat = 0.0\n\n    agent_id = settings.agent_id\n    store_id = settings.store_id\n\n    while True:\n        now = time.time()\n\n        # ========== heartbeat ==========\n        if (now - last_heartbeat) >= float(settings.heartbeat_interval_seconds):\n            hb = {\n                \"agent_id\": agent_id,\n                \"store_id\": store_id,\n                \"cameras\": [\n                    {\n                        \"camera_id\": w.camera_id,\n                        \"name\": w.name,\n                        \"ok\": w.is_ok(),\n                    }\n                    for w in workers\n                ],\n            }\n\n            env = build_envelope(\n                event_name=\"edge_heartbeat\",\n                source=\"edge\",\n                data=hb,\n                meta={},\n            )\n            env[\"receipt_id\"] = compute_receipt_id(env)\n            queue.enqueue(env)\n            last_heartbeat = now\n\n        # ========== process frames ==========\n        for w in workers:\n            f = w.try_get_frame()\n            if f is None:\n                continue\n\n            dets = detector.detect(f.image)\n            metrics = w.update_metrics(dets, f.ts)\n\n            aggregator.add_sample(\n                camera_id=w.camera_id,\n                ts=f.ts,\n                metrics=metrics,\n            )\n\n            # fecha bucket de 60s quando virar o minuto\n            bucket = aggregator.try_close_bucket(camera_id=w.camera_id, ts=f.ts)\n            if bucket is not None:\n                print(\n                    f\"‚úÖ bucket closed cam={w.camera_id} ts_bucket={bucket['ts_bucket']} \"\n                    f\"metrics_keys={list(bucket['metrics'].keys())[:8]}\"\n                )\n\n                data = {\n                    \"store_id\": store_id,\n                    \"camera_id\": w.camera_id,\n                    \"ts_bucket\": bucket[\"ts_bucket\"],\n                    \"metrics\": bucket[\"metrics\"],\n                }\n\n                env = build_envelope(\n                    event_name=\"edge_metric_bucket\",\n                    source=\"edge\",\n                    data=data,\n                    meta={\"agent_id\": agent_id},\n                )\n                env[\"receipt_id\"] = compute_receipt_id(env)\n                queue.enqueue(env)\n                print(f\"üì¶ enqueued edge_metric_bucket receipt={env['receipt_id'][:10]}...\")\n\n                # regras -> alertas\n                alerts = rules.evaluate(camera_id=w.camera_id, bucket=bucket)\n                for a in alerts:\n                    a_data = {\n                        \"store_id\": store_id,\n                        \"camera_id\": w.camera_id,\n                        **a,\n                    }\n                    a_env = build_envelope(\n                        event_name=\"alert\",\n                        source=\"edge\",\n                        data=a_data,\n                        meta={\"agent_id\": agent_id},\n                    )\n                    a_env[\"receipt_id\"] = compute_receipt_id(a_env)\n                    queue.enqueue(a_env)\n\n        # ========== flush outbox ==========\n        if (now - last_flush) >= float(settings.send_interval_seconds):\n            try:\n                r = api.flush_outbox(queue)\n                # log m√≠nimo s√≥ quando houver algo\n                if (r.get(\"sent\", 0) or r.get(\"failed\", 0)):\n                    print(f\"üåê flush sent={r.get('sent')} failed={r.get('failed')} last_error={r.get('last_error')}\")\n            except Exception as e:\n                # nunca derruba o agente por causa de rede/backend\n                print(f\"üåê flush error (ignored): {e}\")\n            last_flush = now\n\n        time.sleep(0.01)\n",
    "edge-agent\\src\\agent\\main.py": "import argparse\n\nfrom .settings import load_settings\nfrom .lifecycle import run_agent\n\n\ndef main():\n    parser = argparse.ArgumentParser()\n    parser.add_argument(\"--config\", required=True, help=\"Path to agent.yaml\")\n    args = parser.parse_args()\n\n    settings = load_settings(args.config)\n    run_agent(settings)\n\n\nif __name__ == \"__main__\":\n    main()\n",
    "edge-agent\\src\\agent\\settings.py": "from dataclasses import dataclass\nfrom typing import Any, Dict, List, Optional\nimport yaml\nimport os\n\n\n@dataclass\nclass CameraConfig:\n    camera_id: str\n    name: str\n    rtsp_url: str\n    roi_config: str\n\n\n@dataclass\nclass Settings:\n    agent_id: str\n    store_id: str\n    timezone: str\n\n    cloud_base_url: str\n    cloud_token: str\n    cloud_timeout: int\n    send_interval_seconds: int\n    heartbeat_interval_seconds: int\n\n    target_width: int\n    fps_limit: int\n    frame_skip: int\n    buffer_sqlite_path: str\n    max_queue_size: int\n    log_level: str\n\n    yolo_weights_path: str\n    conf: float\n    iou: float\n    device: str\n\n    cameras: List[CameraConfig]\n\n\ndef _env_override(d: Dict[str, Any]) -> Dict[str, Any]:\n    \"\"\"\n    Permite override via env (√∫til pra Docker depois).\n    Ex: EDGE_CLOUD_BASE_URL, EDGE_CLOUD_TOKEN, etc.\n    \"\"\"\n    # mantenha simples no v1; expanda conforme precisar\n    base = os.getenv(\"EDGE_CLOUD_BASE_URL\")\n    token = os.getenv(\"EDGE_CLOUD_TOKEN\")\n    if base:\n        d.setdefault(\"cloud\", {})[\"base_url\"] = base\n    if token:\n        d.setdefault(\"cloud\", {})[\"token\"] = token\n    return d\n\n\ndef load_settings(path: str) -> Settings:\n    with open(path, \"r\", encoding=\"utf-8\") as f:\n        raw = yaml.safe_load(f) or {}\n\n    raw = _env_override(raw)\n\n    agent = raw.get(\"agent\", {})\n    cloud = raw.get(\"cloud\", {})\n    runtime = raw.get(\"runtime\", {})\n    model = raw.get(\"model\", {})\n    cams = raw.get(\"cameras\", []) or []\n\n    cameras = [\n        CameraConfig(\n            camera_id=c[\"camera_id\"],\n            name=c.get(\"name\", c[\"camera_id\"]),\n            rtsp_url=c[\"rtsp_url\"],\n            roi_config=c[\"roi_config\"],\n        )\n        for c in cams\n    ]\n\n    return Settings(\n        agent_id=agent[\"agent_id\"],\n        store_id=agent[\"store_id\"],\n        timezone=agent.get(\"timezone\", \"America/Sao_Paulo\"),\n\n        cloud_base_url=cloud[\"base_url\"].rstrip(\"/\"),\n        cloud_token=cloud[\"token\"],\n        cloud_timeout=int(cloud.get(\"timeout_seconds\", 8)),\n        send_interval_seconds=int(cloud.get(\"send_interval_seconds\", 2)),\n        heartbeat_interval_seconds=int(cloud.get(\"heartbeat_interval_seconds\", 15)),\n\n        target_width=int(runtime.get(\"target_width\", 960)),\n        fps_limit=int(runtime.get(\"fps_limit\", 8)),\n        frame_skip=int(runtime.get(\"frame_skip\", 2)),\n        buffer_sqlite_path=str(runtime.get(\"buffer_sqlite_path\", \"./data/edge_queue.db\")),\n        max_queue_size=int(runtime.get(\"max_queue_size\", 50000)),\n        log_level=str(runtime.get(\"log_level\", \"INFO\")),\n\n        yolo_weights_path=str(model.get(\"yolo_weights_path\", \"./models/yolov8n.pt\")),\n        conf=float(model.get(\"conf\", 0.35)),\n        iou=float(model.get(\"iou\", 0.45)),\n        device=str(model.get(\"device\", \"cpu\")),\n\n        cameras=cameras,\n    )\n",
    "edge-agent\\src\\camera\\rtsp.py": "import threading\nimport time\nfrom dataclasses import dataclass\nfrom typing import Optional, Any, Dict, List, Tuple\n\nimport cv2\nimport yaml\nimport numpy as np\n\n\n@dataclass\nclass Frame:\n    image: Any  # np.ndarray (BGR)\n    ts: float\n\n\ndef _point_in_polygon(px: float, py: float, polygon: List[List[int]]) -> bool:\n    \"\"\"\n    polygon: [[x,y], [x,y], ...]\n    \"\"\"\n    if not polygon or len(polygon) < 3:\n        return False\n    contour = np.array(polygon, dtype=np.int32)\n    return cv2.pointPolygonTest(contour, (float(px), float(py)), False) >= 0\n\n\ndef _line_side(p1: Tuple[int, int], p2: Tuple[int, int], p: Tuple[int, int]) -> float:\n    \"\"\"\n    Retorna o \"lado\" do ponto p em rela√ß√£o √† linha p1->p2.\n    Mesma ideia do runner v4.2 (entrada/sa√≠da).\n    \"\"\"\n    return (p2[0] - p1[0]) * (p[1] - p1[1]) - (p2[1] - p1[1]) * (p[0] - p1[0])\n\n\nclass RtspCameraWorker(threading.Thread):\n    def __init__(\n        self,\n        camera_id: str,\n        name: str,\n        rtsp_url: str,\n        roi_config_path: str,\n        target_width: int,\n        fps_limit: int,\n        frame_skip: int,\n    ):\n        super().__init__(daemon=True)\n        self.camera_id = camera_id\n        self.name = name\n        self.rtsp_url = rtsp_url\n        self.target_width = target_width\n        self.fps_limit = fps_limit\n        self.frame_skip = frame_skip\n\n        self._stop = False\n        self._last_frame: Optional[Frame] = None\n        self._ok = False\n        self._last_err = None\n\n        with open(roi_config_path, \"r\", encoding=\"utf-8\") as f:\n            self.roi = yaml.safe_load(f) or {}\n\n        # estado interno (checkout FSM, linhas etc.)\n        self._roi_state: Dict[str, Any] = {\n            # checkout FSM\n            \"in_checkout_cycle\": False,\n            \"interaction_start_ts\": None,\n            \"last_checkout_ts\": -1e9,\n\n            # entrada/sa√≠da (precisa track_id)\n            \"track_line_side_state\": {},   # track_id -> {line_name: side}\n            \"track_line_last_event\": {},   # track_id -> {(entry/exit,line_name): last_ts}\n\n            # debug\n            \"debug_last_counts\": {\n                \"clients_at_pay\": 0,\n                \"staff_at_cashier\": 0,\n            }\n        }\n\n        # cache de zonas/linhas\n        self._zones: Dict[str, List[List[int]]] = (self.roi.get(\"zones\", {}) or {})\n        self._lines_raw = (self.roi.get(\"lines\", {}) or {})\n\n        # normaliza linhas: {\"linha_entrada_saida\": [[x,y],[x,y]]} -> (p1,p2)\n        self._lines: Dict[str, Tuple[Tuple[int, int], Tuple[int, int]]] = {}\n        for ln, pts in self._lines_raw.items():\n            if isinstance(pts, list) and len(pts) == 2:\n                p1 = (int(pts[0][0]), int(pts[0][1]))\n                p2 = (int(pts[1][0]), int(pts[1][1]))\n                self._lines[ln] = (p1, p2)\n\n        # params (defaults iguais ao runner)\n        params = self.roi.get(\"params\", {}) or {}\n        self._exclude_pay_from_queue: bool = bool(params.get(\"exclude_pay_from_queue\", True))\n        self._checkout_dwell_s: float = float(params.get(\"checkout_dwell_seconds\", 2.0))\n        self._checkout_failsafe_s: float = float(params.get(\"checkout_failsafe_seconds\", 4.0))\n        self._line_cooldown_s: float = float(params.get(\"line_cooldown_seconds\", 4.0))\n\n    def _is_rtsp(self) -> bool:\n        return isinstance(self.rtsp_url, str) and self.rtsp_url.lower().startswith(\"rtsp://\")\n\n    def run(self):\n        cap = None\n        last_emit = 0.0\n        skip = 0\n\n        while not self._stop:\n            try:\n                # (re)open\n                if cap is None or not cap.isOpened():\n                    cap = cv2.VideoCapture(self.rtsp_url)\n                    time.sleep(0.3)\n\n                ok, frame = cap.read()\n\n                # ========= EOF / RTSP fail handling =========\n                if not ok or frame is None:\n                    self._ok = False\n\n                    # ‚úÖ Se for arquivo (mp4) e acabou: volta pro come√ßo e continua\n                    if not self._is_rtsp():\n                        try:\n                            cap.set(cv2.CAP_PROP_POS_FRAMES, 0)\n                            time.sleep(0.05)\n                            continue\n                        except Exception as e:\n                            self._last_err = f\"video_loop_error: {e}\"\n\n                    # ‚úÖ Se for RTSP (ou falha s√©ria): libera e tenta reabrir\n                    try:\n                        cap.release()\n                    except Exception:\n                        pass\n                    cap = None\n                    time.sleep(0.5)\n                    continue\n\n                self._ok = True\n\n                # frame skip\n                skip += 1\n                if skip <= self.frame_skip:\n                    continue\n                skip = 0\n\n                # resize\n                h, w = frame.shape[:2]\n                if w > self.target_width:\n                    scale = self.target_width / float(w)\n                    frame = cv2.resize(frame, (self.target_width, int(h * scale)))\n\n                # fps limit\n                now = time.time()\n                if self.fps_limit > 0 and (now - last_emit) < (1.0 / self.fps_limit):\n                    # pequena pausa pra n√£o girar em loop apertado\n                    time.sleep(0.001)\n                    continue\n                last_emit = now\n\n                self._last_frame = Frame(image=frame, ts=now)\n\n            except Exception as e:\n                self._last_err = str(e)\n                self._ok = False\n                # tenta resetar a captura em caso de erro\n                try:\n                    if cap is not None:\n                        cap.release()\n                except Exception:\n                    pass\n                cap = None\n                time.sleep(0.5)\n\n        try:\n            if cap is not None:\n                cap.release()\n        except Exception:\n            pass\n\n    def stop(self):\n        self._stop = True\n\n    def try_get_frame(self) -> Optional[Frame]:\n   ",
    "edge-agent\\src\\events\\builder.py": "from typing import Any, Dict, Optional\nfrom datetime import datetime, timezone\n\n\ndef now_iso() -> str:\n    return datetime.now(timezone.utc).isoformat()\n\n\ndef build_envelope(\n    *,\n    event_name: str,\n    source: str,\n    data: Dict[str, Any],\n    meta: Optional[Dict[str, Any]] = None,\n    event_version: int = 1,\n    lead_id=None,\n    org_id=None\n) -> Dict[str, Any]:\n    return {\n        \"event_id\": data.get(\"event_id\") or None,\n        \"event_name\": str(event_name),\n        \"event_version\": event_version,\n        \"ts\": data.get(\"ts\") or now_iso(),\n        \"source\": source,\n        \"lead_id\": lead_id,\n        \"org_id\": org_id,\n        \"data\": data,\n        \"meta\": meta or {},\n    }\n",
    "edge-agent\\src\\events\\receipts.py": "import hashlib\nimport json\nfrom typing import Any, Dict\n\n\ndef compute_receipt_id(payload: Dict[str, Any]) -> str:\n    \"\"\"\n    Idempot√™ncia: gera um hash est√°vel.\n    Use campos relevantes: store_id + camera_id + event_name + bucket/ts\n    \"\"\"\n    base = {\n        \"event_name\": payload.get(\"event_name\"),\n        \"store_id\": payload.get(\"data\", {}).get(\"store_id\"),\n        \"camera_id\": payload.get(\"data\", {}).get(\"camera_id\"),\n        \"ts\": payload.get(\"ts\"),\n        \"event_version\": payload.get(\"event_version\", 1),\n    }\n    raw = json.dumps(base, sort_keys=True, ensure_ascii=False).encode(\"utf-8\")\n    return hashlib.sha256(raw).hexdigest()\n",
    "edge-agent\\src\\storage\\__init__.py": "",
    "edge-agent\\src\\storage\\sqlite_queue.py": "import os\nimport sqlite3\nimport json\nimport time\nfrom typing import Any, Dict, List, Tuple\n\n\nclass SqliteQueue:\n    def __init__(self, path: str):\n        self.path = path\n\n        # garante que o diret√≥rio existe (Windows)\n        db_dir = os.path.dirname(os.path.abspath(self.path))\n        if db_dir and not os.path.exists(db_dir):\n            os.makedirs(db_dir, exist_ok=True)\n\n        self._conn = sqlite3.connect(self.path, check_same_thread=False)\n        self._conn.row_factory = sqlite3.Row\n        self._init_db()\n\n    def _init_db(self):\n        \"\"\"\n        Cria a tabela de outbox (offline-first).\n        \"\"\"\n        self._conn.execute(\n            \"\"\"\n            CREATE TABLE IF NOT EXISTS outbox (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                receipt_id TEXT UNIQUE,\n                payload_json TEXT NOT NULL,\n                attempts INTEGER DEFAULT 0,\n                last_error TEXT,\n                created_at REAL NOT NULL,\n                next_attempt_at REAL DEFAULT 0\n            )\n            \"\"\"\n        )\n        self._conn.execute(\n            \"CREATE INDEX IF NOT EXISTS idx_outbox_next_attempt ON outbox(next_attempt_at)\"\n        )\n        self._conn.commit()\n\n    def enqueue(self, payload: Dict[str, Any]) -> bool:\n        \"\"\"\n        Insere evento no outbox.\n        receipt_id deve vir dentro do payload.\n        \"\"\"\n        try:\n            receipt_id = payload[\"receipt_id\"]\n            self._conn.execute(\n                \"\"\"\n                INSERT OR IGNORE INTO outbox\n                (receipt_id, payload_json, created_at, next_attempt_at)\n                VALUES (?, ?, ?, 0)\n                \"\"\",\n                (\n                    receipt_id,\n                    json.dumps(payload, ensure_ascii=False),\n                    time.time(),\n                ),\n            )\n            self._conn.commit()\n            return True\n        except Exception as e:\n            print(\"‚ùå enqueue error:\", e)\n            return False\n\n    def peek_batch(self, limit: int = 50) -> List[Tuple[int, str, Dict[str, Any], int]]:\n        \"\"\"\n        Retorna eventos prontos para envio.\n        \"\"\"\n        now = time.time()\n        rows = self._conn.execute(\n            \"\"\"\n            SELECT id, receipt_id, payload_json, attempts\n            FROM outbox\n            WHERE next_attempt_at <= ?\n            ORDER BY id ASC\n            LIMIT ?\n            \"\"\",\n            (now, limit),\n        ).fetchall()\n\n        out = []\n        for row in rows:\n            out.append(\n                (\n                    row[\"id\"],\n                    row[\"receipt_id\"],\n                    json.loads(row[\"payload_json\"]),\n                    row[\"attempts\"],\n                )\n            )\n        return out\n\n    def mark_sent(self, row_id: int):\n        self._conn.execute(\"DELETE FROM outbox WHERE id = ?\", (row_id,))\n        self._conn.commit()\n\n    def mark_failed(self, row_id: int, error: str, attempts: int, backoff_seconds: int):\n        next_at = time.time() + backoff_seconds\n        self._conn.execute(\n            \"\"\"\n            UPDATE outbox\n            SET last_error = ?, attempts = ?, next_attempt_at = ?\n            WHERE id = ?\n            \"\"\",\n            (error[:1000], attempts, next_at, row_id),\n        )\n        self._conn.commit()\n",
    "edge-agent\\src\\transport\\api_client.py": "import time\nimport requests\nfrom typing import Any, Dict\n\n\nclass ApiClient:\n    def __init__(self, base_url: str, token: str, timeout: int):\n        self.base_url = base_url.rstrip(\"/\")\n        self.timeout = timeout\n        self.session = requests.Session()\n        self.session.headers.update({\n            \"X-EDGE-TOKEN\": token,\n            \"Content-Type\": \"application/json\",\n        })\n\n    def post_event(self, payload: Dict[str, Any]) -> Dict[str, Any]:\n        \"\"\"\n        Endpoint sugerido: POST /api/edge/events/\n        \"\"\"\n        url = f\"{self.base_url}/api/edge/events/\"\n        r = self.session.post(url, json=payload, timeout=self.timeout)\n        if r.ok:\n            try:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": r.json()}\n            except Exception:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": {\"text\": r.text}}\n        return {\"ok\": False, \"status\": r.status_code, \"error\": r.text}\n\n    def flush_outbox(self, queue, batch_size: int = 50) -> Dict[str, Any]:\n        \"\"\"\n        L√™ eventos do SqliteQueue e tenta postar pro backend.\n        Em caso de falha, aplica backoff exponencial simples.\n        \"\"\"\n        sent = 0\n        failed = 0\n        last_error = None\n\n        batch = queue.peek_batch(limit=batch_size)\n        for row_id, receipt_id, payload, attempts in batch:\n            try:\n                res = self.post_event(payload)\n\n                if res.get(\"ok\"):\n                    queue.mark_sent(row_id)\n                    sent += 1\n                else:\n                    attempts = int(attempts) + 1\n                    backoff = min(300, 2 ** min(attempts, 8))  # 2s,4s,8s... at√© 300s\n                    last_error = str(res.get(\"error\") or res)\n                    queue.mark_failed(\n                        row_id=row_id,\n                        error=last_error,\n                        attempts=attempts,\n                        backoff_seconds=backoff,\n                    )\n                    failed += 1\n\n            except Exception as e:\n                attempts = int(attempts) + 1\n                backoff = min(300, 2 ** min(attempts, 8))\n                last_error = str(e)\n                queue.mark_failed(\n                    row_id=row_id,\n                    error=last_error,\n                    attempts=attempts,\n                    backoff_seconds=backoff,\n                )\n                failed += 1\n\n        return {\"ok\": True, \"sent\": sent, \"failed\": failed, \"last_error\": last_error}\n",
    "edge-agent\\src\\vision\\aggregations.py": "from __future__ import annotations\n\nfrom dataclasses import dataclass, field\nfrom typing import Dict, Any, Optional\nimport math\n\n\n@dataclass\nclass _Bucket:\n    ts_bucket: int  # epoch start do bucket (segundos)\n    count: int = 0\n    sums: Dict[str, float] = field(default_factory=dict)\n    maxs: Dict[str, float] = field(default_factory=dict)\n\n\nclass MetricAggregator:\n    \"\"\"\n    Agregador simples por camera_id.\n    - Buckets fixos de bucket_seconds (ex.: 60s)\n    - Produz m√©tricas *_avg e *_max por bucket\n    \"\"\"\n\n    def __init__(self, bucket_seconds: int = 60):\n        self.bucket_seconds = int(bucket_seconds)\n        self._buckets: Dict[str, _Bucket] = {}\n\n    def _bucket_start(self, ts: float) -> int:\n        # in√≠cio do bucket em epoch-segundos (ex.: minuto)\n        return int(math.floor(ts / self.bucket_seconds) * self.bucket_seconds)\n\n    def add_sample(self, camera_id: str, ts: float, metrics: Dict[str, Any]) -> None:\n        \"\"\"\n        Adiciona uma amostra instant√¢nea no bucket corrente da c√¢mera.\n        \"\"\"\n        bstart = self._bucket_start(ts)\n        b = self._buckets.get(camera_id)\n\n        if b is None or b.ts_bucket != bstart:\n            # inicia novo bucket (n√£o fecha o anterior aqui)\n            self._buckets[camera_id] = _Bucket(ts_bucket=bstart)\n            b = self._buckets[camera_id]\n\n        b.count += 1\n\n        # agrega apenas n√∫meros\n        for k, v in (metrics or {}).items():\n            if isinstance(v, bool):\n                v = int(v)\n            if isinstance(v, (int, float)):\n                fv = float(v)\n                b.sums[k] = b.sums.get(k, 0.0) + fv\n                b.maxs[k] = fv if k not in b.maxs else max(b.maxs[k], fv)\n\n    def try_close_bucket(self, camera_id: str, ts: float) -> Optional[Dict[str, Any]]:\n        \"\"\"\n        Fecha e retorna o bucket anterior quando o tempo j√° avan√ßou para o pr√≥ximo bucket.\n        Retorna None se ainda estamos no mesmo bucket.\n        \"\"\"\n        b = self._buckets.get(camera_id)\n        if b is None:\n            return None\n\n        current_start = self._bucket_start(ts)\n        if current_start == b.ts_bucket:\n            return None  # ainda no mesmo bucket\n\n        # fecha o bucket b e j√° cria o novo bucket para o current_start\n        closed = b\n        self._buckets[camera_id] = _Bucket(ts_bucket=current_start)\n\n        out_metrics: Dict[str, Any] = {}\n\n        denom = max(1, closed.count)\n        for k, s in closed.sums.items():\n            out_metrics[f\"{k}_avg\"] = s / denom\n        for k, m in closed.maxs.items():\n            out_metrics[f\"{k}_max\"] = m\n\n        return {\n            \"ts_bucket\": closed.ts_bucket,\n            \"count\": closed.count,\n            \"metrics\": out_metrics,\n        }\n",
    "edge-agent\\src\\vision\\detector.py": "# edge-agent/src/vision/detector.py\nfrom __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import List, Dict, Any, Optional\n\nimport numpy as np\n\ntry:\n    from ultralytics import YOLO\nexcept Exception as e:\n    YOLO = None  # type: ignore\n\n\n@dataclass\nclass Detection:\n    cls_name: str\n    conf: float\n    xyxy: List[float]  # [x1,y1,x2,y2]\n\n\nclass PersonDetector:\n    def __init__(\n        self,\n        weights_path: str,\n        conf: float = 0.35,\n        iou: float = 0.45,\n        device: str = \"cpu\",\n    ):\n        if YOLO is None:\n            raise RuntimeError(\"ultralytics n√£o est√° instalado. pip install ultralytics\")\n\n        self.model = YOLO(weights_path)\n        self.conf = conf\n        self.iou = iou\n        self.device = device\n\n    def detect(self, frame_bgr: np.ndarray) -> List[Detection]:\n        \"\"\"\n        Retorna apenas pessoas (class 0 no COCO geralmente).\n        \"\"\"\n        results = self.model.predict(\n            source=frame_bgr,\n            conf=self.conf,\n            iou=self.iou,\n            device=self.device,\n            verbose=False,\n        )\n\n        dets: List[Detection] = []\n        if not results:\n            return dets\n\n        r0 = results[0]\n        if r0.boxes is None:\n            return dets\n\n        # boxes: xyxy, conf, cls\n        xyxy = r0.boxes.xyxy.cpu().numpy()\n        confs = r0.boxes.conf.cpu().numpy()\n        clss = r0.boxes.cls.cpu().numpy().astype(int)\n\n        # nomes (se existir)\n        names = getattr(self.model, \"names\", None) or {}\n\n        for box, cf, c in zip(xyxy, confs, clss):\n            cls_name = names.get(c, str(c))\n            if cls_name != \"person\" and c != 0:\n                continue\n            x1, y1, x2, y2 = [float(v) for v in box.tolist()]\n            dets.append(Detection(cls_name=\"person\", conf=float(cf), xyxy=[x1, y1, x2, y2]))\n\n        return dets\n",
    "edge-agent\\src\\vision\\rules.py": "from typing import Dict, Any, List\n\nclass RuleEngine:\n    def evaluate(self, bucket: Dict[str, Any]) -> List[Dict[str, Any]]:\n        \"\"\"\n        Transformar m√©tricas de bucket em alertas.\n        No v1, mantenha 1‚Äì2 regras simples.\n        \"\"\"\n        events = []\n        m = bucket[\"metrics\"]\n\n        # Exemplo: fila longa baseado em people_count_max\n        people_max = m.get(\"people_count_max\")\n        if people_max is not None and people_max >= 6:\n            events.append({\n                \"event_type\": \"queue_long\",\n                \"severity\": \"warning\",\n                \"title\": \"Poss√≠vel fila longa\",\n                \"description\": f\"Pico de pessoas detectadas: {people_max}\",\n                \"metadata\": {\"ts_bucket\": bucket[\"ts_bucket\"], \"people_max\": people_max},\n            })\n        return events\n",
    "apps\\edge\\__init__.py": "",
    "apps\\edge\\admin.py": "from django.contrib import admin\n\n# Register your models here.\n",
    "apps\\edge\\apps.py": "from django.apps import AppConfig\n\n\nclass EdgeConfig(AppConfig):\n    default_auto_field = \"django.db.models.BigAutoField\"\n    name = \"apps.edge\"\n",
    "apps\\edge\\migrations\\0001_initial.py": "# Generated by Django 4.2.11 on 2026-01-28 21:42\n\nfrom django.db import migrations, models\n\n\nclass Migration(migrations.Migration):\n\n    initial = True\n\n    dependencies = [\n    ]\n\n    operations = [\n        migrations.CreateModel(\n            name='EdgeEventReceipt',\n            fields=[\n                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ('receipt_id', models.CharField(max_length=128, unique=True)),\n                ('event_name', models.CharField(max_length=64)),\n                ('source', models.CharField(default='edge', max_length=32)),\n                ('store_id', models.CharField(blank=True, max_length=64, null=True)),\n                ('payload', models.JSONField(default=dict)),\n                ('created_at', models.DateTimeField(auto_now_add=True)),\n            ],\n        ),\n    ]\n",
    "apps\\edge\\migrations\\__init__.py": "",
    "apps\\edge\\models.py": "from django.db import models\n\nclass EdgeEventReceipt(models.Model):\n    receipt_id = models.CharField(max_length=128, unique=True)\n    event_name = models.CharField(max_length=64)\n    source = models.CharField(max_length=32, default=\"edge\")\n    store_id = models.CharField(max_length=64, null=True, blank=True)\n    payload = models.JSONField(default=dict)\n    created_at = models.DateTimeField(auto_now_add=True)\n\n    def __str__(self):\n        return f\"{self.event_name} {self.receipt_id[:10]}\"\n\n",
    "apps\\edge\\permissions.py": "# apps/edge/permissions.py\nimport os\nfrom rest_framework.permissions import BasePermission\n\n\nclass EdgeTokenPermission(BasePermission):\n    \"\"\"\n    Valida header X-EDGE-TOKEN contra EDGE_AGENT_TOKEN do .env/settings.\n    \"\"\"\n\n    def has_permission(self, request, view):\n        expected = os.getenv(\"EDGE_AGENT_TOKEN\") or \"\"\n        provided = request.headers.get(\"X-EDGE-TOKEN\") or \"\"\n        return bool(expected) and (provided == expected)\n",
    "apps\\edge\\serializers.py": "from rest_framework import serializers\n\n\nclass EdgeEventSerializer(serializers.Serializer):\n    event_name = serializers.CharField()\n    ts = serializers.CharField(required=False)\n    source = serializers.CharField(required=False)\n    data = serializers.DictField(required=False)\n    meta = serializers.DictField(required=False)\n    receipt_id = serializers.CharField(required=False, allow_blank=True)\n\n    event_version = serializers.IntegerField(required=False)\n    event_id = serializers.CharField(required=False, allow_null=True)\n    org_id = serializers.CharField(required=False, allow_null=True)\n",
    "apps\\edge\\tests.py": "from django.test import TestCase\n\n# Create your tests here.\n",
    "apps\\edge\\urls.py": "from django.urls import path\nfrom .views import EdgeEventsIngestView\n\nurlpatterns = [\n    path(\"events/\", EdgeEventsIngestView.as_view(), name=\"edge-events\"),\n]\n",
    "apps\\alerts\\__init__.py": "",
    "apps\\alerts\\admin.py": "from django.contrib import admin\n\n# Register your models here.\n",
    "apps\\alerts\\apps.py": "from django.apps import AppConfig\n\n\nclass AlertsConfig(AppConfig):\n    name = 'apps.alerts'\n    verbose_name = 'Alerts'\n",
    "apps\\alerts\\migrations\\__init__.py": "",
    "apps\\alerts\\models.py": "from django.db import models\n\n# Create your models here.\n",
    "apps\\alerts\\serializers.py": "# apps/alerts/serializers.py\nfrom rest_framework import serializers\n\nfrom apps.core.models import (\n    DemoLead,\n    AlertRule,\n    DetectionEvent,\n    EventMedia,\n    NotificationLog,\n    JourneyEvent,\n)\n\nclass DemoLeadSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = DemoLead\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\", \"status\")\n\nclass AlertRuleSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = AlertRule\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\", \"updated_at\")\n\nclass EventMediaSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = EventMedia\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n\nclass DetectionEventSerializer(serializers.ModelSerializer):\n    media = serializers.SerializerMethodField()\n\n    class Meta:\n        model = DetectionEvent\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n\n    def get_media(self, obj):\n        qs = EventMedia.objects.filter(event_id=obj.id).order_by(\"-created_at\")\n        return EventMediaSerializer(qs, many=True).data\n\nclass NotificationLogSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = NotificationLog\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"sent_at\")\n\nclass JourneyEventSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = JourneyEvent\n        fields = \"__all__\"\n        read_only_fields = (\"id\", \"created_at\")\n",
    "apps\\alerts\\services.py": "# apps/alerts/services.py\nimport requests\nfrom typing import Optional, Dict, Any\nfrom django.conf import settings\nfrom django.utils import timezone\n\n\nDEFAULT_TIMEOUT = 8\n\n\ndef _get_webhook() -> Optional[str]:\n    \"\"\"\n    Webhook √∫nico para eventos (leads, calendly, alerts, billing, etc.)\n    \"\"\"\n    return getattr(settings, \"N8N_EVENTS_WEBHOOK\", None)\n\n\ndef send_event_to_n8n(\n    *,\n    event_name: str,\n    data: Dict[str, Any],\n    event_id: Optional[str] = None,\n    lead_id: Optional[str] = None,\n    org_id: Optional[str] = None,\n    source: str = \"backend\",\n    event_version: int = 1,\n    meta: Optional[Dict[str, Any]] = None,\n    timeout: int = DEFAULT_TIMEOUT,\n) -> Dict[str, Any]:\n    \"\"\"\n    Envia um evento padronizado para o n8n.\n    - event_name: \"lead_created\", \"alert_triggered\", \"invoice_overdue\", etc.\n    - data: payload espec√≠fico do evento\n    - event_id: idealmente o UUID do JourneyEvent (idempot√™ncia)\n    - lead_id/org_id: usados para roteamento e auditoria\n    - meta: extras √∫teis (ip, user_agent, request_id, etc.)\n    \"\"\"\n    webhook = _get_webhook()\n    if not webhook:\n        return {\"ok\": False, \"error\": \"N8N_EVENTS_WEBHOOK not configured\"}\n\n    payload = {\n        \"event_id\": str(event_id) if event_id else None,\n        \"event_name\": event_name,\n        \"event_version\": event_version,\n        \"source\": source,\n        \"ts\": timezone.now().isoformat(),\n        \"lead_id\": str(lead_id) if lead_id else None,\n        \"org_id\": str(org_id) if org_id else None,\n        \"data\": data or {},\n        \"meta\": meta or {},\n    }\n\n    try:\n        r = requests.post(webhook, json=payload, timeout=timeout)\n        if r.ok:\n            try:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": r.json()}\n            except Exception:\n                return {\"ok\": True, \"status\": r.status_code, \"data\": {\"text\": r.text}}\n        return {\"ok\": False, \"status\": r.status_code, \"error\": r.text}\n    except Exception as e:\n        return {\"ok\": False, \"error\": str(e)}\n",
    "apps\\alerts\\tests.py": "from django.test import TestCase\n\n# Create your tests here.\n",
    "apps\\alerts\\urls.py": "# apps/alerts/urls.py\nfrom django.urls import path, include\nfrom rest_framework.routers import DefaultRouter\nfrom .views import (\n    DemoLeadCreateView,\n    AlertRuleViewSet,\n    DetectionEventViewSet,\n    NotificationLogViewSet,\n    CoreStoreListView,\n    JourneyEventViewSet,\n)\n\nrouter = DefaultRouter()\nrouter.register(r\"alert-rules\", AlertRuleViewSet, basename=\"alert-rules\")\nrouter.register(r\"events\", DetectionEventViewSet, basename=\"events\")\nrouter.register(r\"notification-logs\", NotificationLogViewSet, basename=\"notification-logs\")\nrouter.register(r\"journey-events\", JourneyEventViewSet, basename=\"journey-events\")\n\nurlpatterns = [\n    path(\"stores/\", CoreStoreListView.as_view(), name=\"alerts-core-stores\"),\n    path(\"demo-leads/\", DemoLeadCreateView.as_view(), name=\"demo-leads\"),\n    path(\"\", include(router.urls)),\n]\n",
    "apps\\alerts\\views.py": "# apps/alerts/views.py\nfrom datetime import timedelta\nfrom uuid import UUID\n\nfrom django.utils import timezone\nfrom rest_framework import viewsets, permissions, status, serializers\nfrom rest_framework.decorators import action\nfrom rest_framework.exceptions import ValidationError\nfrom rest_framework.response import Response\nfrom rest_framework.views import APIView\n\nfrom apps.core.models import (\n    DemoLead,\n    AlertRule,\n    DetectionEvent,\n    EventMedia,\n    NotificationLog,\n    Store,\n)\nfrom .serializers import (\n    DemoLeadSerializer,\n    AlertRuleSerializer,\n    DetectionEventSerializer,\n    EventMediaSerializer,\n    NotificationLogSerializer,\n)\nfrom .services import send_event_to_n8n\n\nfrom apps.core.models import JourneyEvent\nfrom .serializers import JourneyEventSerializer\nfrom django.db.utils import DataError\n# =========================\n# CORE STORES (UUID) - para o frontend filtrar alerts corretamente\n# GET /api/alerts/stores/\n# =========================\nclass CoreStoreSerializer(serializers.ModelSerializer):\n    class Meta:\n        model = Store\n        fields = (\"id\", \"name\")\n\n\nclass CoreStoreListView(APIView):\n    permission_classes = [permissions.IsAuthenticated]\n\n    def get(self, request):\n        qs = Store.objects.all().order_by(\"name\")\n        return Response(CoreStoreSerializer(qs, many=True).data)\n\n\n# =========================\n# Helpers\n# =========================\ndef is_uuid(value: str) -> bool:\n    try:\n        UUID(str(value))\n        return True\n    except Exception:\n        return False\n\n\ndef require_uuid_param(name: str, value: str):\n    if not is_uuid(value):\n        raise ValidationError({name: f'{name} deve ser um UUID v√°lido (core.Store). Recebido: \"{value}\".'})\n\n\n# =========================\n# DEMO LEAD (FORM P√öBLICO) ‚Äî Op√ß√£o A (DEDUPE por email/whatsapp)\n# =========================\nclass DemoLeadCreateView(APIView):\n    permission_classes = [permissions.AllowAny]\n\n    def post(self, request):\n        now = timezone.now()\n\n        email = (request.data.get(\"email\") or \"\").strip()\n        whatsapp = (request.data.get(\"whatsapp\") or \"\").strip()\n\n        active_statuses = [\"new\", \"contacted\", \"scheduled\"]\n        existing = None\n\n        if email:\n            existing = (\n                DemoLead.objects.filter(email__iexact=email, status__in=active_statuses)\n                .order_by(\"-created_at\")\n                .first()\n            )\n\n        if not existing and whatsapp:\n            existing = (\n                DemoLead.objects.filter(whatsapp=whatsapp, status__in=active_statuses)\n                .order_by(\"-created_at\")\n                .first()\n            )\n\n        if existing:\n            # 1) grava JourneyEvent\n            je = JourneyEvent.objects.create(\n                lead_id=existing.id,\n                org_id=None,\n                event_name=\"lead_duplicate_attempt\",\n                payload={\n                    \"source\": \"demo_form\",\n                    \"reason\": \"duplicate_active_lead\",\n                    \"status\": existing.status,\n                    \"email\": email or existing.email,\n                    \"whatsapp\": whatsapp or existing.whatsapp,\n                },\n                created_at=now,\n            )\n\n            # 2) dispara n8n (webhook √∫nico)\n            # Obs: n√£o pode quebrar o fluxo do usu√°rio\n            try:\n                send_event_to_n8n(\n                    event_name=\"lead_duplicate_attempt\",\n                    event_id=str(je.id),\n                    lead_id=str(existing.id),\n                    org_id=None,\n                    source=\"backend\",\n                    data={\n                        \"lead_id\": str(existing.id),\n                        \"status\": existing.status,\n                        \"email\": existing.email,\n                        \"whatsapp\": existing.whatsapp,\n                        \"created_at\": existing.created_at.isoformat() if existing.created_at else None,\n                    },\n                    meta={\n                        \"ip\": request.META.get(\"REMOTE_ADDR\"),\n                        \"user_agent\": request.META.get(\"HTTP_USER_AGENT\"),\n                    },\n                )\n            except Exception:\n                pass\n\n            return Response(DemoLeadSerializer(existing).data, status=status.HTTP_200_OK)\n\n        # -------------------------\n        # 1) Cria lead\n        # -------------------------\n        serializer = DemoLeadSerializer(data=request.data)\n        serializer.is_valid(raise_exception=True)\n        lead = serializer.save(status=\"new\", created_at=now)\n\n        # -------------------------\n        # 2) JourneyEvent: lead_created\n        # -------------------------\n        je = JourneyEvent.objects.create(\n            lead_id=lead.id,\n            org_id=None,\n            event_name=\"lead_created\",\n            payload={\n                \"source\": \"demo_form\",\n                \"lead_id\": str(lead.id),\n                \"email\": lead.email,\n                \"whatsapp\": lead.whatsapp,\n                \"operation_type\": getattr(lead, \"operation_type\", None),\n                \"stores_range\": getattr(lead, \"stores_range\", None),\n                \"cameras_range\": getattr(lead, \"cameras_range\", None),\n                \"primary_goal\": getattr(lead, \"primary_goal\", None),\n                \"primary_goals\": getattr(lead, \"primary_goals\", None),\n                \"qualified_score\": getattr(lead, \"qualified_score\", None),\n            },\n            created_at=now,\n        )\n\n        # -------------------------\n        # 3) Dispara n8n (webhook √∫nico)\n        # -------------------------\n        send_event_to_n8n(\n            event_name=\"lead_created\",\n            event_id=str(je.id),              # <- idempot√™ncia\n            lead_id=str(lead.id),\n            org_id=None,\n            source=\"backend\",\n            data={\n                \"lead_id\": str(lead.id),\n                \"contact_name\": lead.contact_name,\n                \"email\": lead.email,\n                \"whatsapp\": lead.whatsapp,\n     ",
    "backend\\__init__.py": "",
    "backend\\asgi.py": "\"\"\"\nASGI config for backend project.\n\nIt exposes the ASGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/asgi/\n\"\"\"\n\nimport os\n\nfrom django.core.asgi import get_asgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\napplication = get_asgi_application()\n",
    "backend\\settings.py": "# backend/settings.py\nimport os\nfrom pathlib import Path\nfrom dotenv import load_dotenv\nfrom datetime import timedelta\n# Carrega vari√°veis do .env\nload_dotenv()\n\nBASE_DIR = Path(__file__).resolve().parent.parent\n\n# SECURITY WARNING: keep the secret key used in production secret!\nSECRET_KEY = os.getenv('DJANGO_SECRET_KEY', 'django-insecure-change-me-in-production!')\n\n# SECURITY WARNING: don't run with debug turned on in production!\nDEBUG = os.getenv('DEBUG', 'True') == 'True'\n\nALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')\n\n# ‚≠ê APPLICATION DEFINITION - APENAS ESSENCIAIS INICIALMENTE\nINSTALLED_APPS = [\n    'django.contrib.admin',\n    'django.contrib.auth',      # ‚≠ê N√ÉO CRIAR 'apps.auth' - ESTE √â O OFICIAL\n    'django.contrib.contenttypes',\n    'django.contrib.sessions',\n    'django.contrib.messages',\n    'django.contrib.staticfiles',\n    \n    # Third party\n    'rest_framework',\n    'corsheaders',\n    'knox',\n    'django_filters',\n    'drf_yasg',\n    \n    # ‚≠ê LOCAL APPS - VAMOS CRIAR AGORA\n    'apps.accounts',\n    'apps.core',\n    'apps.stores',\n    'apps.cameras', \n    'apps.vision',\n    'apps.analytics',\n    'apps.alerts',\n    'apps.billing',\n    \"apps.edge\",\n]\n\nMIDDLEWARE = [\n    'corsheaders.middleware.CorsMiddleware',\n    'django.middleware.security.SecurityMiddleware',\n    'whitenoise.middleware.WhiteNoiseMiddleware',\n    'django.contrib.sessions.middleware.SessionMiddleware',\n    'django.middleware.common.CommonMiddleware',\n    'django.middleware.csrf.CsrfViewMiddleware',\n    'django.contrib.auth.middleware.AuthenticationMiddleware',\n    'django.contrib.messages.middleware.MessageMiddleware',\n    'django.middleware.clickjacking.XFrameOptionsMiddleware',\n]\n\nROOT_URLCONF = 'backend.urls'\n\nTEMPLATES = [\n    {\n        'BACKEND': 'django.template.backends.django.DjangoTemplates',\n        'DIRS': [],\n        'APP_DIRS': True,\n        'OPTIONS': {\n            'context_processors': [\n                'django.template.context_processors.debug',\n                'django.template.context_processors.request',\n                'django.contrib.auth.context_processors.auth',\n                'django.contrib.messages.context_processors.messages',\n            ],\n        },\n    },\n]\n\nWSGI_APPLICATION = 'backend.wsgi.application'\n\n# ‚≠ê DATABASE - Supabase Postgres (prod e dev)\nDATABASES = {\n    'default': {\n        'ENGINE': 'django.db.backends.postgresql',\n        'NAME': os.getenv('DB_NAME', 'postgres'),\n        'USER': os.getenv('DB_USER', 'postgres'),\n        'PASSWORD': os.getenv('DB_PASSWORD', ''),\n        'HOST': os.getenv('DB_HOST', ''),\n        'PORT': os.getenv('DB_PORT', '5432'),\n        'OPTIONS': {\n            'sslmode': os.getenv('DB_SSLMODE', 'require'),\n        }\n    }\n}\n\n# Password validation\nAUTH_PASSWORD_VALIDATORS = [\n    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},\n    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},\n]\n\n# Internationalization\nLANGUAGE_CODE = 'pt-br'\nTIME_ZONE = 'America/Sao_Paulo'\nUSE_I18N = True\nUSE_TZ = True\n\n# Static files (CSS, JavaScript, Images)\nSTATIC_URL = 'static/'\nSTATIC_ROOT = BASE_DIR / 'staticfiles'\n\n# Default primary key field type\nDEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'\n\n# ‚≠ê REST FRAMEWORK CONFIG\nREST_FRAMEWORK = {\n    'DEFAULT_AUTHENTICATION_CLASSES': ('knox.auth.TokenAuthentication',),\n    'DEFAULT_PERMISSION_CLASSES': ('rest_framework.permissions.IsAuthenticatedOrReadOnly',),\n    'DEFAULT_FILTER_BACKENDS': ['django_filters.rest_framework.DjangoFilterBackend'],\n    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',\n    'PAGE_SIZE': 50,\n}\n\n# ‚≠ê CORS CONFIG\nCORS_ALLOWED_ORIGINS = [\n    \"http://localhost:5173\",\n    \"http://127.0.0.1:5173\",\n]\nCORS_ALLOW_CREDENTIALS = True\n\nCORS_ALLOW_METHODS = [\n    'DELETE',\n    'GET',\n    'OPTIONS',\n    'PATCH',\n    'POST',\n    'PUT',\n]\nCORS_ALLOW_HEADERS = [\n    'accept',\n    'accept-encoding',\n    'authorization',\n    'content-type',\n    'dnt',\n    'origin',\n    'user-agent',\n    'x-csrftoken',\n    'x-requested-with',\n]\n# ‚≠ê KNOX CONFIG\nREST_KNOX = {\n    'TOKEN_TTL': timedelta(days=30),\n    'AUTO_REFRESH': True,\n}\n\n# ‚≠ê SUPABASE CONFIG (SEUS DADOS)\nSUPABASE_URL = os.getenv(\"SUPABASE_URL\")\nSUPABASE_KEY = os.getenv(\"SUPABASE_KEY\")\nN8N_EVENTS_WEBHOOK = os.getenv(\"N8N_EVENTS_WEBHOOK\")\n# ‚≠ê WHITENOISE (para arquivos est√°ticos)\nSTATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'\n\nEDGE_SERVICE_USERNAME = os.getenv(\"EDGE_SERVICE_USERNAME\", \"edge-agent\")\nEDGE_AGENT_TOKEN = os.getenv(\"EDGE_AGENT_TOKEN\", \"\")",
    "backend\\urls.py": "# backend/urls.py\nfrom django.contrib import admin\nfrom django.urls import path, include\nfrom django.http import JsonResponse\nfrom rest_framework import permissions\nfrom drf_yasg.views import get_schema_view\nfrom drf_yasg import openapi\n\ndef home(request):\n    return JsonResponse({\n        \"app\": \"Dale Vision IA\",\n        \"version\": \"1.0.0\",\n        \"status\": \"online\",\n        \"documentation\": \"/swagger/\",\n        \"endpoints\": {\n            \"register\": \"/api/accounts/register/\",\n            \"login\": \"/api/accounts/login/\",\n            \"logout\": \"/api/accounts/logout/\",\n            \"stores\": \"/api/v1/stores/\",\n            \"alerts\": \"/api/alerts/\",\n        }\n    })\n\nschema_view = get_schema_view(\n    openapi.Info(\n        title=\"Dale Vision API\",\n        default_version=\"v1\",\n        description=\"API de Vis√£o Computacional para Varejo\",\n        contact=openapi.Contact(email=\"dev@dalevision.ai\"),\n        license=openapi.License(name=\"Proprietary\"),\n    ),\n    public=True,\n    permission_classes=[permissions.AllowAny],\n)\n\nurlpatterns = [\n    path(\"\", home),\n    path(\"admin/\", admin.site.urls),\n\n    path(\"swagger/\", schema_view.with_ui(\"swagger\", cache_timeout=0), name=\"swagger-ui\"),\n    path(\"redoc/\", schema_view.with_ui(\"redoc\", cache_timeout=0), name=\"redoc\"),\n\n    # ‚úÖ Accounts centralizado\n    path(\"api/accounts/\", include(\"apps.accounts.urls\")),\n\n    # ‚úÖ Core (demo lead etc) ‚Äî se voc√™ for colocar aqui depois\n    # path(\"api/core/\", include(\"apps.core.urls\")),\n\n    # ‚úÖ Stores\n    path(\"api/v1/\", include(\"apps.stores.urls\")),\n\n    # ‚úÖ Alerts (demo lead + rules + ingest/event)\n    path(\"api/alerts/\", include(\"apps.alerts.urls\")),\n    path(\"api/cameras/\", include(\"apps.cameras.urls\")),\n\n    path(\"health/\", lambda r: JsonResponse({\"status\": \"healthy\", \"service\": \"dale-vision-api\"})),\n    path(\"api/edge/\", include(\"apps.edge.urls\")),\n]\n",
    "backend\\wsgi.py": "\"\"\"\nWSGI config for backend project.\n\nIt exposes the WSGI callable as a module-level variable named ``application``.\n\nFor more information on this file, see\nhttps://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/\n\"\"\"\n\nimport os\n\nfrom django.core.wsgi import get_wsgi_application\n\nos.environ.setdefault('DJANGO_SETTINGS_MODULE', 'backend.settings')\n\napplication = get_wsgi_application()\n"
  }
}